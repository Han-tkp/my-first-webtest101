<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yonchuw – ระบบจอง ยืม-คืน และซ่อมบำรุง</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    /* ใช้ฟอนต์ Noto Sans Thai เป็นหลัก */
    body {
      font-family: 'Noto Sans Thai', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
    }

    /* พื้นหลังแบบไล่ระดับสีเพื่อความสวยงาม */
    .bg-grad {
      background: radial-gradient(1200px 600px at 80% -10%, rgba(79, 70, 229, .18), transparent 60%), linear-gradient(135deg, #0ea5e9 0%, #2563eb 50%, #7c3aed 100%);
    }

    /* เอฟเฟกต์กระจกฝ้าสำหรับ Topbar */
    .glass {
      backdrop-filter: saturate(140%) blur(10px);
      background: rgba(255, 255, 255, 0.08);
    }

    /* การ์ดหลักใช้พื้นหลังสีขาวเกือบทึบ */
    .card {
      background: rgba(255, 255, 255, 0.96);
    }

    /* Animation สำหรับการเปลี่ยนหน้า */
    .fade-in {
      animation: fade .35s ease-out;
    }

    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* สไตล์สำหรับ Chip แสดงคุณสมบัติ */
    .chip {
      background: rgba(99, 102, 241, .12);
      color: #4338ca;
      font-weight: 500;
    }

    /* สไตล์สำหรับปุ่มที่ถูกปิดใช้งาน */
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>

<body class="min-h-screen bg-grad text-white transition-all duration-300">
  <!-- Topbar -->
  <header class="sticky top-0 z-30 glass">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3 cursor-pointer" onclick="show('home')">
        <div class="w-9 h-9 rounded-xl bg-white/20 flex items-center justify-center">
          <!-- ไอคอนระบบ -->
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
            <path d="m7 11 2-2-2-2" />
            <path d="M11 13h4" />
            <path d="m17 11 2 2-2 2" />
            <path d="M21 12a9 9 0 1 1-6.2-8.7" />
          </svg>
        </div>
        <div>
          <p class="font-semibold text-lg">Yonchuw</p>
          <p class="text-white/80 text-xs -mt-0.5">ระบบบริหารจัดการเครื่องพ่นหมอกควัน</p>
        </div>
      </div>
      <nav class="flex items-center gap-2" id="nav-actions">
        <button id="btnLogin" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">เข้าสู่ระบบ</button>
        <button id="btnRegister"
          class="px-4 py-2 rounded-lg bg-white text-slate-900 font-semibold hover:opacity-90 transition">ลงทะเบียน</button>
        <div id="userInfo" class="hidden items-center gap-3">
          <span id="userNameDisplay" class="text-sm font-medium"></span>
          <button id="btnLogout"
            class="px-4 py-2 rounded-lg bg-red-500/20 text-red-100 hover:bg-red-500/40 transition text-sm">ออกจากระบบ</button>
        </div>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- หน้าแรก / Hero Section -->
    <section id="home" class="fade-in">
      <div class="grid md:grid-cols-2 gap-8 items-start">
        <div>
          <h1 class="text-4xl sm:text-5xl font-bold leading-tight tracking-tighter">ระบบจอง ยืม-คืน และซ่อมบำรุง</h1>
          <p class="mt-4 text-lg text-white/90">ลดขั้นตอนงานเอกสาร เพิ่มประสิทธิภาพการทำงาน
            ติดตามสถานะอุปกรณ์ได้แบบเรียลไทม์</p>
          <div class="mt-8 flex flex-wrap gap-4">
            <button id="startBtn"
              class="px-6 py-3 rounded-xl bg-white text-slate-900 font-semibold hover:opacity-90 transition-transform hover:scale-105">เริ่มต้นใช้งาน</button>
            <button id="browseBtn"
              class="px-6 py-3 rounded-xl bg-white/10 hover:bg-white/20 transition">ดูรายการอุปกรณ์</button>
          </div>
          <div class="mt-6 flex items-center gap-3 text-sm">
            <span class="chip px-3 py-1 rounded-full">Responsive</span>
            <span class="chip px-3 py-1 rounded-full">Role-based</span>
            <span class="chip px-3 py-1 rounded-full">Real-time</span>
          </div>
        </div>
        <!-- คู่มือการใช้งาน -->
        <div class="card rounded-2xl p-6 text-slate-900 shadow-xl">
          <div class="flex items-center justify-between">
            <p class="font-semibold">คู่มือใช้งานอย่างย่อ</p>
            <span class="text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 font-medium">Demo</span>
          </div>
          <ol class="mt-4 space-y-2.5 text-sm text-slate-700 list-decimal list-inside">
            <li><strong>ลงทะเบียน:</strong> ผู้ใช้ใหม่ลงทะเบียน → สถานะเป็น “รอตรวจสอบ”</li>
            <li><strong>อนุมัติบัญชี:</strong> ผู้อนุมัติทำการอนุมัติ → ผู้ใช้จึงจะเข้าสู่ระบบได้</li>
            <li><strong>ส่งคำขอยืม:</strong> ผู้ใช้ทั่วไปส่งคำขอยืม (ต้องระบุรายละเอียดให้ครบถ้วน)</li>
            <li><strong>อนุมัติการยืม:</strong> ผู้อนุมัติอนุมัติคำขอ → สถานะอุปกรณ์เปลี่ยนเป็น “ถูกยืม”</li>
            <li><strong>คืนอุปกรณ์:</strong> เมื่อคืนอุปกรณ์ ช่างจะตรวจสภาพและตัดสินว่า “เสีย/ไม่เสีย”</li>
            <li><strong>ขั้นตอนการซ่อม:</strong> หากเสีย → สร้างคำขอซ่อม → อนุมัติซ่อม → ซ่อมเสร็จ → อุปกรณ์กลับมา
              “ว่าง”</li>
          </ol>
          <div class="mt-5 p-3 rounded-lg bg-slate-50 border text-sm text-slate-600">
            <strong>บัญชีทดสอบ (รหัสผ่าน: password)</strong>
            <ul class="list-disc list-inside mt-1">
              <li>admin@example.com (ผู้ดูแลระบบ)</li>
              <li>approver@example.com (ผู้อนุมัติ)</li>
              <li>tech@example.com (ช่างเทคนิค)</li>
              <li>user@example.com (ผู้ใช้ทั่วไป)</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- หน้าแสดงรายการอุปกรณ์ (สำหรับคนทั่วไป) -->
    <section id="equipmentShowcase" class="hidden fade-in">
      <div class="flex items-center justify-between mb-6">
        <button id="backFromEquip"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
          <svg width="18" height="18" viewBox="0 0 24 24">
            <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8l8 8l1.41-1.41L7.83 13H20v-2z" />
          </svg>
          กลับหน้าหลัก
        </button>
        <h2 class="text-xl font-semibold">รายการอุปกรณ์ทั้งหมด</h2>
        <div></div> <!-- Spacer -->
      </div>
      <div class="card rounded-2xl p-6 text-slate-900">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <input id="equipSearch" placeholder="ค้นหาชื่อหรือ Serial"
              class="px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
            <select id="equipFilter" class="px-3 py-2 rounded-lg border border-slate-200">
              <option value="">สถานะทั้งหมด</option>
              <option value="available">ว่าง</option>
              <option value="borrowed">ถูกยืม</option>
              <option value="under_maintenance">ซ่อมบำรุง</option>
            </select>
          </div>
          <button id="btnAddEquip"
            class="hidden px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">เพิ่มอุปกรณ์</button>
        </div>
        <div id="equipList" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Equipment cards will be rendered here -->
        </div>
      </div>
    </section>

    <!-- หน้าเข้าสู่ระบบ -->
    <section id="loginPage" class="hidden fade-in">
      <div class="max-w-md mx-auto card rounded-2xl p-8 text-slate-900 shadow-xl">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold">เข้าสู่ระบบ</h2>
          <button id="backFromLogin"
            class="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">กลับ</button>
        </div>
        <form id="loginForm" class="mt-6 space-y-4">
          <input name="email" type="email" required placeholder="อีเมล"
            class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <input name="password" type="password" required placeholder="รหัสผ่าน"
            class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <button type="submit"
            class="w-full px-4 py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition">เข้าสู่ระบบ</button>
        </form>
        <p class="mt-4 text-sm text-center text-slate-600">ยังไม่มีบัญชี? <a href="#" id="goRegister"
            class="font-medium text-indigo-600 hover:underline">ลงทะเบียนที่นี่</a></p>
      </div>
    </section>

    <!-- หน้าลงทะเบียน -->
    <section id="registerPage" class="hidden fade-in">
      <div class="max-w-xl mx-auto card rounded-2xl p-8 text-slate-900 shadow-xl">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold">ลงทะเบียนผู้ใช้งานใหม่</h2>
          <button id="backFromRegister"
            class="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">กลับ</button>
        </div>
        <form id="registerForm" class="mt-6 grid sm:grid-cols-2 gap-4">
          <input name="full_name" required placeholder="ชื่อ-สกุล"
            class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <input name="agency" required placeholder="หน่วยงาน"
            class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <textarea name="address" placeholder="ที่อยู่หน่วยงาน" rows="2"
            class="sm:col-span-2 px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea>
          <input name="email" type="email" required placeholder="อีเมล"
            class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <input name="password" type="password" required placeholder="รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)" minlength="6"
            class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
          <button type="submit"
            class="sm:col-span-2 px-4 py-3 rounded-lg bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition">ยืนยันการลงทะเบียน</button>
        </form>
        <div class="mt-4 text-sm text-amber-800 bg-amber-50 border border-amber-200 rounded-lg p-3">
          <strong>หมายเหตุ:</strong> หลังลงทะเบียน บัญชีจะอยู่ในสถานะ “รอตรวจสอบ”
          และจะใช้งานได้ต่อเมื่อผู้อนุมัติทำการอนุมัติเรียบร้อยแล้ว
        </div>
      </div>
    </section>

    <!-- Dashboard (สำหรับผู้ใช้ที่ login แล้ว) -->
    <section id="dashboard" class="hidden fade-in">
      <!-- Tabs -->
      <div class="mt-4 overflow-x-auto">
        <div class="inline-flex gap-1 bg-white/10 rounded-xl p-1">
          <button data-tab="equipmentTab" class="tab-btn px-4 py-2 rounded-lg">ภาพรวมอุปกรณ์</button>
          <button data-tab="borrowTab" class="tab-btn px-4 py-2 rounded-lg">ยืม-คืน</button>
          <button data-tab="techTab" class="tab-btn px-4 py-2 rounded-lg">ส่วนงานช่าง</button>
          <button data-tab="approvalTab" class="tab-btn px-4 py-2 rounded-lg">จัดการคำขอ</button>
          <button data-tab="assessmentTab" class="tab-btn px-4 py-2 rounded-lg">ประเมินมาตรฐาน</button>
          <button data-tab="reportTab" class="tab-btn px-4 py-2 rounded-lg">รายงาน</button>
        </div>
      </div>

      <!-- เนื้อหาของแต่ละ Tab -->
      <div class="mt-6">
        <!-- Equipment Tab Content -->
        <div id="equipmentTab" class="tab-content">
          <div class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 card rounded-2xl p-6 text-slate-900">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <h3 class="text-lg font-semibold">รายการอุปกรณ์</h3>
                <div class="flex items-center gap-2">
                  <input id="dashEquipSearch" placeholder="ค้นหา"
                    class="px-3 py-2 w-32 rounded-lg border border-slate-200">
                  <select id="dashEquipFilter" class="px-3 py-2 rounded-lg border border-slate-200">
                    <option value="">ทั้งหมด</option>
                    <option value="available">ว่าง</option>
                    <option value="borrowed">ถูกยืม</option>
                    <option value="under_maintenance">ซ่อมบำรุง</option>
                    <option value="pending_repair_approval">รออนุมัติซ่อม</option>
                  </select>
                  <button id="btnAddEquipDash"
                    class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 hidden">เพิ่ม</button>
                </div>
              </div>
              <div id="dashEquipList" class="mt-4 grid sm:grid-cols-2 gap-4"></div>
            </div>
            <div class="card rounded-2xl p-6 text-slate-900">
              <h3 class="text-lg font-semibold">สรุปสถานะ</h3>
              <div id="equipmentSummary" class="grid grid-cols-2 gap-4 mt-4"></div>
            </div>
          </div>
        </div>

        <!-- Borrow Tab Content (User) -->
        <div id="borrowTab" class="hidden tab-content">
          <div class="grid lg:grid-cols-3 gap-6">
            <div class="card rounded-2xl p-6 text-slate-900" id="borrowFormContainer">
              <h3 class="text-lg font-semibold">สร้างคำขอยืมอุปกรณ์</h3>
              <form id="borrowForm" class="mt-4 space-y-3">
                <select name="borrowEquipSelect" id="borrowEquipSelect"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200" required></select>
                <div class="grid sm:grid-cols-2 gap-3">
                  <input name="ref_doc_no" placeholder="หนังสือเลขที่"
                    class="w-full px-3 py-2 rounded-lg border border-slate-200">
                  <input name="ref_doc_topic" placeholder="เรื่อง"
                    class="w-full px-3 py-2 rounded-lg border border-slate-200">
                </div>
                <div class="grid sm:grid-cols-2 gap-3">
                  <input type="date" name="borrow_date" id="borrowDate"
                    class="px-3 py-2 rounded-lg border border-slate-200" required>
                  <input type="date" id="dueDate" class="px-3 py-2 rounded-lg border border-slate-200 bg-slate-50"
                    readonly>
                </div>
                <input name="purpose" placeholder="วัตถุประสงค์/พื้นที่ปฏิบัติงาน"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200" required>
                <div class="grid sm:grid-cols-2 gap-3">
                  <input name="contact_name" placeholder="ผู้ประสานงาน"
                    class="px-3 py-2 rounded-lg border border-slate-200" required>
                  <input name="contact_phone" placeholder="เบอร์โทรติดต่อ"
                    class="px-3 py-2 rounded-lg border border-slate-200" required>
                </div>
                <textarea name="notes" rows="2" placeholder="รายละเอียดเพิ่มเติม (เช่น พื้นที่เสี่ยง, เวลาเริ่มงาน)"
                  class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                <button
                  class="w-full px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">ส่งคำขอ</button>
              </form>
              <p class="text-xs text-slate-500 mt-2">หมายเหตุ: ระบบจะกำหนดวันคืนอัตโนมัติ 7 วันนับจากวันที่ยืม</p>
            </div>
            <div class="lg:col-span-2 card rounded-2xl p-6 text-slate-900">
              <div class="mb-4">
                <h3 class="text-lg font-semibold">เครื่องที่กำลังยืม</h3>
                <div id="currentlyBorrowed" class="mt-2 space-y-3"></div>
              </div>
              <hr class="my-4">
              <div>
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold">ประวัติการยืม-คืน</h3>
                  <div id="borrowHistoryFilter" class="flex items-center gap-1 bg-slate-100 p-1 rounded-lg">
                    <button data-filter="all" class="px-3 py-1 text-sm rounded-md bg-white shadow">ทั้งหมด</button>
                    <button data-filter="borrowed" class="px-3 py-1 text-sm rounded-md">กำลังยืม</button>
                    <button data-filter="returned" class="px-3 py-1 text-sm rounded-md">คืนแล้ว</button>
                  </div>
                </div>
                <div id="myBorrowsHistory" class="mt-4 space-y-3"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Technician Tab Content -->
        <div id="techTab" class="hidden tab-content">
          <div class="grid lg:grid-cols-3 gap-6">
            <div class="card rounded-2xl p-6 text-slate-900">
              <h3 class="text-lg font-semibold">รายการรอส่งมอบ</h3>
              <div id="techDeliveryQueue" class="mt-4 space-y-3"></div>
            </div>
            <div class="card rounded-2xl p-6 text-slate-900">
              <h3 class="text-lg font-semibold">รายการรอตรวจสภาพ (หลังคืน)</h3>
              <div id="techReturnQueue" class="mt-4 space-y-3"></div>
            </div>
            <div class="card rounded-2xl p-6 text-slate-900">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">รายการซ่อมบำรุง</h3>
                <button id="exportRepairsBtn"
                  class="px-3 py-1 text-xs rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300">Export</button>
              </div>
              <div id="repairList" class="mt-4 space-y-3"></div>
            </div>
          </div>
        </div>

        <!-- Approval Tab Content -->
        <div id="approvalTab" class="hidden tab-content">
          <div class="grid lg:grid-cols-2 gap-6">
            <div class="card rounded-2xl p-6 text-slate-900">
              <h3 class="text-lg font-semibold">อนุมัติบัญชีผู้ใช้ใหม่</h3>
              <div id="approvalUsers" class="mt-3 space-y-3"></div>
            </div>
            <div class="card rounded-2xl p-6 text-slate-900">
              <h3 class="text-lg font-semibold">อนุมัติการยืม</h3>
              <div id="approvalBorrowList" class="mt-3 space-y-3"></div>
            </div>
            <div class="card rounded-2xl p-6 text-slate-900 lg:col-span-2">
              <h3 class="text-lg font-semibold">อนุมัติการซ่อม</h3>
              <div id="approvalRepairList" class="mt-3 space-y-3"></div>
            </div>
          </div>
        </div>

        <!-- Assessment Tab Content -->
        <div id="assessmentTab" class="hidden tab-content">
          <div class="card rounded-2xl p-6 text-slate-900">
            <h3 class="text-lg font-semibold">ประเมินมาตรฐานเครื่องพ่น</h3>
            <p class="text-sm text-slate-600 mt-1">เลือกเครื่องพ่นที่ต้องการบันทึกการประเมินประสิทธิภาพ</p>
            <div id="assessmentEquipList" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </div>
        </div>

        <!-- Report Tab Content -->
        <div id="reportTab" class="hidden tab-content">
          <div class="card rounded-2xl p-6 text-slate-900">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">แดชบอร์ดรายงาน</h3>
              <button id="exportReportsBtn"
                class="px-4 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Export
                รายงานรวม</button>
            </div>
            <div id="reportCards" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modal"
    class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
    <div id="modalContent"
      class="bg-white rounded-2xl p-6 text-slate-900 w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300">
      <div class="flex items-center justify-between">
        <h3 id="modalTitle" class="text-xl font-bold">Modal Title</h3>
        <button id="modalClose" class="text-2xl leading-none text-slate-400 hover:text-slate-800">&times;</button>
      </div>
      <div id="modalBody" class="mt-4">
        <!-- Dynamic content goes here -->
      </div>
    </div>
  </div>


  <!-- Toast Notification -->
  <div id="toast"
    class="fixed bottom-5 left-1/2 -translate-x-1/2 px-5 py-3 rounded-lg text-white text-sm font-medium shadow-lg hidden transition-all duration-300">
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // =================================================================================
      // MOCK STATE & API (ส่วนจำลองฐานข้อมูลและ Backend)
      // =================================================================================
      const state = {
        user: null, // {id, name, role}
        equipment: [
          { id: 1, serial: '0334 0418 0044', name: 'HUDSON X-PERT SPRAYER', status: 'available' },
          { id: 2, serial: '0334 0418 0045', name: 'HUDSON X-PERT SPRAYER', status: 'available' },
          { id: 3, serial: 'สคร.0334 0429 0863 0124', name: 'IK VECTOR CONTROL SUPER', status: 'available' },
          { id: 4, serial: 'สคร.0334 0429 0465 0140', name: 'IK VECTOR CONTROL SUPER', status: 'available' },
          { id: 5, serial: '51 6640 007 00005 (67)', name: 'Micron CS10', status: 'available' },
          { id: 6, serial: '0332 048 0001 (8666)', name: 'SWING FOG SN 50', status: 'borrowed' },
          { id: 7, serial: '0332 012.4 0010 (NR070542604)', name: 'IGEBA PORT 123 ULV', status: 'available' },
          { id: 8, serial: '0332 012.4 0012', name: 'SWING FOG SN50', status: 'under_maintenance' },
          { id: 9, serial: '0332 0418 0098 (TL 060545)', name: 'TWISTER XL BY DYNAFOG', status: 'available' },
          { id: 10, serial: 'สคร.0332 0418 0105 (154710)', name: 'Swingtec ULV', status: 'available' },
          { id: 11, serial: 'สคร.0332 0418 0121', name: 'FONTAN PORTASTARS', status: 'pending_repair_approval' },
          { id: 12, serial: 'สคร.0332 0418 0122', name: 'FONTAN PORTASTARS', status: 'available' },
          { id: 13, serial: '0334 0461 1260', name: 'Misuko 3WF-3A', status: 'available' },
          { id: 14, serial: '0332 0461 11600124 (164841)', name: 'ULV Swingtac', status: 'available' },
        ],
        borrows: [
          { id: 1, equipment_id: 6, user_id: 4, user_name: 'ผู้ใช้ทั่วไป', borrow_date: '2025-09-10', due_date: '2025-09-17', return_date: null, purpose: 'พ่นป้องกันไข้เลือดออก หมู่บ้านจัดสรร', contact_name: 'คุณสมศรี', contact_phone: '081-234-5678', notes: 'ขอเข้าพื้นที่ช่วงบ่าย', status: 'borrowed' }
        ],
        repairs: [
          { id: 1, equipment_id: 8, equipment_name: 'SWING FOG SN50', damage_description: 'ระบบพ่นทำงานผิดปกติ', status: 'repair_approved', technician_id: 3, repair_details: null, cost: null, parts_used: null },
          { id: 2, equipment_id: 11, equipment_name: 'FONTAN PORTASTARS', damage_description: 'สตาร์ทไม่ติด', status: 'pending_repair_approval', technician_id: null, repair_details: null, cost: null, parts_used: null }
        ],
        users: [
          { id: 1, full_name: 'ผู้ดูแลระบบ', email: 'admin@example.com', role: 'admin', status: 'active', agency: 'ส่วนกลาง', address: '-' },
          { id: 2, full_name: 'ผู้อนุมัติ', email: 'approver@example.com', role: 'approver', status: 'active', agency: 'สำนักงานใหญ่', address: '-' },
          { id: 3, full_name: 'ช่างเทคนิค', email: 'tech@example.com', role: 'technician', status: 'active', agency: 'แผนกซ่อมบำรุง', address: '-' },
          { id: 4, full_name: 'ผู้ใช้ทั่วไป', email: 'user@example.com', role: 'user', status: 'active', agency: 'อบต. ตัวอย่าง', address: '123 ถ.สุขุมวิท' },
        ],
        pendingUsers: [
          { id: 5, full_name: 'สมชาย ใจดี', email: 'somchai@example.com', role: 'user', status: 'pending_approval', agency: 'เทศบาลนคร', address: '456 ถ.เพชรเกษม' }
        ],
        assessments: [],
        seq: { borrow: 2, repair: 3, user: 6, equip: 15, assessment: 1 }
      };

      const api = {
        login: async (email, password) => {
          const u = state.users.find(x => x.email === email);
          if (!u || password !== 'password') throw new Error('อีเมลหรือรหัสผ่านไม่ถูกต้อง');
          if (u.status !== 'active') throw new Error('บัญชียังไม่เปิดใช้งาน');
          return { id: u.id, name: u.full_name, role: u.role };
        },
        register: async (data) => {
          if (state.users.some(u => u.email === data.email) || state.pendingUsers.some(u => u.email === data.email)) throw new Error('อีเมลนี้ถูกใช้แล้ว');
          state.pendingUsers.push({ id: state.seq.user++, ...data, role: 'user', status: 'pending_approval' });
          return { message: 'ลงทะเบียนสำเร็จ กำลังรอผู้อนุมัติอนุมัติ' };
        },
        listPendingUsers: async () => state.pendingUsers,
        approveUser: async (id) => {
          const idx = state.pendingUsers.findIndex(u => u.id === id);
          if (idx < 0) throw new Error('ไม่พบบัญชี');
          const [u] = state.pendingUsers.splice(idx, 1);
          state.users.push({ ...u, status: 'active' });
          return true;
        },
        rejectUser: async (id) => {
          state.pendingUsers = state.pendingUsers.filter(u => u.id !== id);
          return true;
        },
        equipmentList: async (q = '', f = '') => {
          let list = [...state.equipment];
          if (q) list = list.filter(e => e.name.toLowerCase().includes(q.toLowerCase()) || e.serial.toLowerCase().includes(q.toLowerCase()));
          if (f) list = list.filter(e => e.status === f);
          return list;
        },
        addEquipment: async (data) => {
          if (state.equipment.some(e => e.serial === data.serial)) throw new Error('Serial number นี้มีอยู่แล้ว');
          state.equipment.push({ id: state.seq.equip++, ...data, status: 'available' });
          return true;
        },
        updateEquipment: async (id, data) => {
          const equip = state.equipment.find(e => e.id === id);
          if (!equip) throw new Error('ไม่พบอุปกรณ์');
          Object.assign(equip, data);
          return true;
        },
        deleteEquipment: async (id) => {
          state.equipment = state.equipment.filter(e => e.id !== id);
          return true;
        },
        createBorrow: async (payload) => {
          const eq = state.equipment.find(e => e.id === payload.equipment_id);
          if (!eq || eq.status !== 'available') throw new Error('อุปกรณ์ไม่ว่างหรือไม่มีอยู่');
          const due = new Date(payload.borrow_date); due.setDate(due.getDate() + 7);
          const due_date = due.toISOString().slice(0, 10);
          state.borrows.push({
            id: state.seq.borrow++, ...payload,
            user_name: state.user.name, due_date, return_date: null,
            status: 'pending_borrow_approval'
          });
          return true;
        },
        myBorrows: async (user_id) => state.borrows.filter(b => b.user_id === user_id).sort((a, b) => b.id - a.id),
        listBorrowRequests: async () => state.borrows.filter(b => b.status === 'pending_borrow_approval'),
        approveBorrow: async (id) => {
          const b = state.borrows.find(x => x.id === id); if (!b) throw new Error('ไม่พบรายการ');
          b.status = 'pending_delivery';
          return true;
        },
        performPreDeliveryCheck: async (id, isFaulty, newEquipId, checklistData) => {
          const b = state.borrows.find(x => x.id === id); if (!b) throw new Error('ไม่พบรายการ');
          b.pre_delivery_checklist = checklistData;
          if (isFaulty) {
            const oldEquip = state.equipment.find(e => e.id === b.equipment_id);
            if (oldEquip) oldEquip.status = 'pending_repair_approval';
            state.repairs.push({ id: state.seq.repair++, equipment_id: oldEquip.id, equipment_name: oldEquip.name, damage_description: 'ตรวจพบปัญหาก่อนส่งมอบ', status: 'pending_repair_approval', technician_id: null });

            b.equipment_id = newEquipId;
          }
          b.status = 'borrowed';
          const eq = state.equipment.find(e => e.id === b.equipment_id); if (eq) eq.status = 'borrowed';
          return true;
        },
        rejectBorrow: async (id) => {
          const b = state.borrows.find(x => x.id === id); if (!b) throw new Error('ไม่พบรายการ');
          b.status = 'rejected'; return true;
        },
        queueForDelivery: async () => state.borrows.filter(b => b.status === 'pending_delivery'),
        queueForReturn: async () => state.borrows.filter(b => b.status === 'borrowed' && !b.return_date),
        techInspectReturn: async (id, isDamaged, notes, checklistData) => {
          const b = state.borrows.find(x => x.id === id); if (!b) throw new Error('ไม่พบรายการ');
          b.return_date = new Date().toISOString().slice(0, 10);
          b.post_return_checklist = checklistData;
          const eq = state.equipment.find(e => e.id === b.equipment_id);
          if (isDamaged) {
            b.status = 'returned_damaged';
            if (eq) eq.status = 'pending_repair_approval';
            state.repairs.push({ id: state.seq.repair++, equipment_id: b.equipment_id, equipment_name: eq.name, damage_description: notes || 'ชำรุดจากการใช้งาน', status: 'pending_repair_approval', technician_id: null });
          } else {
            b.status = 'returned';
            if (eq) eq.status = 'available';
          }
          return true;
        },
        listRepairs: async () => state.repairs.sort((a, b) => b.id - a.id),
        listRepairRequests: async () => state.repairs.filter(r => r.status === 'pending_repair_approval'),
        approveRepair: async (id) => {
          const r = state.repairs.find(x => x.id === id); if (!r) throw new Error('ไม่พบรายการ');
          r.status = 'repair_approved';
          r.technician_id = state.user.role === 'technician' ? state.user.id : null;
          const eq = state.equipment.find(e => e.id === r.equipment_id); if (eq) eq.status = 'under_maintenance';
          return true;
        },
        rejectRepair: async (id) => {
          const r = state.repairs.find(x => x.id === id); if (!r) throw new Error('ไม่พบรายการ');
          r.status = 'repair_rejected';
          const eq = state.equipment.find(e => e.id === r.equipment_id); if (eq) eq.status = 'available';
          return true;
        },
        completeRepair: async (id, details) => {
          const r = state.repairs.find(x => x.id === id); if (!r) throw new Error('ไม่พบรายการ');
          r.status = 'completed';
          Object.assign(r, details);
          const eq = state.equipment.find(e => e.id === r.equipment_id); if (eq) eq.status = 'available';
          return true;
        },
        createAssessment: async (data) => {
          state.assessments.push({ id: state.seq.assessment++, ...data, date: new Date().toISOString().slice(0, 10) });
          return true;
        },
        reportOverview: async () => {
          const total = state.equipment.length;
          const borrowed = state.equipment.filter(e => e.status === 'borrowed').length;
          const maintenance = state.equipment.filter(e => ['under_maintenance', 'pending_repair_approval'].includes(e.status)).length;
          const available = state.equipment.filter(e => e.status === 'available').length;
          return [
            { label: 'อุปกรณ์ทั้งหมด', value: total, color: 'bg-blue-100 text-blue-800' },
            { label: 'ว่าง', value: available, color: 'bg-emerald-100 text-emerald-800' },
            { label: 'กำลังใช้งาน', value: borrowed, color: 'bg-indigo-100 text-indigo-800' },
            { label: 'รอ/กำลังซ่อม', value: maintenance, color: 'bg-amber-100 text-amber-800' },
          ];
        }
      };

      // =================================================================================
      // UTILS (ฟังก์ชันช่วยเหลือทั่วไป)
      // =================================================================================
      const $ = (selector) => document.querySelector(selector);
      const $$ = (selector) => document.querySelectorAll(selector);

      const toast = (msg, isError = false) => {
        const el = $('#toast');
        el.textContent = msg;
        el.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-5 py-3 rounded-lg text-white text-sm font-medium shadow-lg transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-slate-800'}`;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 2500);
      };

      const show = (id) => {
        $$('main section').forEach(s => s.classList.add('hidden'));
        $(`#${id}`).classList.remove('hidden');
      };

      const setTabs = (tabId) => {
        $$('.tab-btn').forEach(b => {
          const isSelected = b.dataset.tab === tabId;
          b.classList.toggle('bg-white', isSelected);
          b.classList.toggle('text-slate-900', isSelected);
          b.classList.toggle('font-semibold', isSelected);
          b.classList.toggle('hover:bg-white/20', !isSelected);
        });
        $$('.tab-content').forEach(c => c.classList.toggle('hidden', c.id !== tabId));
      };

      const showModal = (title, content, actions) => {
        $('#modalTitle').textContent = title;
        $('#modalBody').innerHTML = content + (actions ? `<div class="mt-6 flex justify-end gap-3">${actions}</div>` : '');
        $('#modal').classList.remove('hidden');
        setTimeout(() => {
          $('#modal').style.opacity = '1';
          $('#modalContent').classList.remove('scale-95');
        }, 10);
      };

      const hideModal = () => {
        $('#modal').style.opacity = '0';
        $('#modalContent').classList.add('scale-95');
        setTimeout(() => $('#modal').classList.add('hidden'), 300);
      };

      const statusMap = {
        available: { text: 'ว่าง', color: 'bg-emerald-100 text-emerald-800' },
        borrowed: { text: 'ถูกยืม', color: 'bg-indigo-100 text-indigo-800' },
        under_maintenance: { text: 'ซ่อมบำรุง', color: 'bg-amber-100 text-amber-800' },
        pending_repair_approval: { text: 'รออนุมัติซ่อม', color: 'bg-rose-100 text-rose-800' }
      };

      // =================================================================================
      // RENDER FUNCTIONS (ฟังก์ชันสำหรับวาด UI)
      // =================================================================================

      async function renderEquipmentLists(isAdminAction = false) {
        const q1 = $('#equipSearch')?.value || '';
        const f1 = $('#equipFilter')?.value || '';
        const list1 = await api.equipmentList(q1, f1);
        $('#equipList').innerHTML = list1.map(e => {
          const { text, color } = statusMap[e.status] || { text: 'N/A', color: 'bg-gray-100' };
          const canBorrow = e.status === 'available' && state.user?.role === 'user';
          return `
                    <div class="rounded-xl border border-slate-200 p-4 bg-white flex flex-col justify-between">
                        <div>
                            <div class="font-semibold">${e.name}</div>
                            <div class="text-sm text-slate-500">S/N: ${e.serial}</div>
                            <span class="mt-2 inline-block text-xs font-medium px-2 py-1 rounded-full ${color}">${text}</span>
                        </div>
                        ${canBorrow ? `<button onclick="handleBorrowClick(${e.id})" class="mt-3 w-full text-center px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm">ขอยืม</button>` : ''}
                    </div>
                `;
        }).join('') || `<p class="text-slate-500">ไม่พบอุปกรณ์</p>`;

        if (state.user) {
          const q2 = $('#dashEquipSearch')?.value || '';
          const f2 = $('#dashEquipFilter')?.value || '';
          const list2 = await api.equipmentList(q2, f2);
          $('#dashEquipList').innerHTML = list2.map(e => {
            const { text, color } = statusMap[e.status] || { text: 'N/A', color: 'bg-gray-100' };
            const adminButtons = state.user.role === 'admin' ? `
                        <div class="mt-2 flex gap-2">
                            <button onclick="handleEditEquipmentClick(${e.id})" class="text-xs text-blue-600 hover:underline">แก้ไข</button>
                            <button onclick="handleDeleteEquipmentClick(${e.id})" class="text-xs text-red-600 hover:underline">ลบ</button>
                        </div>
                    ` : '';
            return `
                        <div class="rounded-xl border border-slate-200 p-4 bg-white">
                            <div class="font-semibold">${e.name}</div>
                            <div class="text-sm text-slate-500">S/N: ${e.serial}</div>
                            <span class="mt-2 inline-block text-xs font-medium px-2 py-1 rounded-full ${color}">${text}</span>
                            ${adminButtons}
                        </div>
                    `;
          }).join('') || `<p class="text-slate-500">ไม่พบอุปกรณ์</p>`;

          if (isAdminAction || ['admin', 'technician'].includes(state.user.role)) {
            $('#assessmentEquipList').innerHTML = list2.map(e => `
                        <button onclick="handleAssessmentClick(${e.id}, '${e.name}')" class="text-left p-4 rounded-xl border border-slate-200 hover:bg-slate-50">
                            <div class="font-semibold">${e.name}</div>
                            <div class="text-sm text-slate-500">S/N: ${e.serial}</div>
                        </button>
                    `).join('');
          }
        }
      }
      window.handleBorrowClick = (equipId) => {
        show('dashboard');
        setTabs('borrowTab');
        $('#borrowEquipSelect').value = equipId;
      }

      async function renderEquipmentSummary() {
        const summary = await api.reportOverview();
        $('#equipmentSummary').innerHTML = summary.map(item => `
                <div class="rounded-xl p-4 ${item.color}">
                    <div class="text-sm">${item.label}</div>
                    <div class="text-2xl font-bold mt-1">${item.value}</div>
                </div>
            `).join('');
      }

      async function renderMyBorrows() {
        if (!state.user || state.user.role !== 'user') return;

        const allMyBorrows = await api.myBorrows(state.user.id);

        // Render currently borrowed
        const currentlyBorrowed = allMyBorrows.filter(b => ['borrowed', 'pending_delivery'].includes(b.status));
        $('#currentlyBorrowed').innerHTML = currentlyBorrowed.length === 0
          ? `<p class="text-slate-500 text-sm">ไม่มีเครื่องที่กำลังยืม</p>`
          : currentlyBorrowed.map(b => renderBorrowCard(b)).join('');

        // Render history with filter
        const filter = $('#borrowHistoryFilter .bg-white').dataset.filter;
        let historyBorrows = [];
        if (filter === 'all') {
          historyBorrows = allMyBorrows;
        } else if (filter === 'borrowed') {
          historyBorrows = allMyBorrows.filter(b => ['pending_borrow_approval', 'pending_delivery', 'borrowed'].includes(b.status));
        } else if (filter === 'returned') {
          historyBorrows = allMyBorrows.filter(b => ['returned', 'returned_damaged', 'rejected'].includes(b.status));
        }

        $('#myBorrowsHistory').innerHTML = historyBorrows.length === 0
          ? `<p class="text-slate-500 text-sm">ไม่มีประวัติ</p>`
          : historyBorrows.map(b => renderBorrowCard(b)).join('');
      }

      function renderBorrowCard(b) {
        const eq = state.equipment.find(e => e.id === b.equipment_id);
        let statusText, statusColor;
        switch (b.status) {
          case 'pending_borrow_approval': statusText = 'รออนุมัติ'; statusColor = 'bg-yellow-100 text-yellow-800'; break;
          case 'pending_delivery': statusText = 'รอช่างตรวจ'; statusColor = 'bg-cyan-100 text-cyan-800'; break;
          case 'borrowed': statusText = 'ยืมอยู่'; statusColor = 'bg-blue-100 text-blue-800'; break;
          case 'rejected': statusText = 'ไม่อนุมัติ'; statusColor = 'bg-red-100 text-red-800'; break;
          case 'returned': statusText = 'คืนแล้ว'; statusColor = 'bg-green-100 text-green-800'; break;
          case 'returned_damaged': statusText = 'คืน (ชำรุด)'; statusColor = 'bg-orange-100 text-orange-800'; break;
          default: statusText = 'ไม่ทราบสถานะ'; statusColor = 'bg-gray-100 text-gray-800';
        }
        return `
               <div class="p-3 rounded-lg border border-slate-200 text-sm">
                   <div class="flex justify-between items-start">
                      <span class="font-semibold">${eq?.name || 'N/A'}</span>
                      <span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">${statusText}</span>
                   </div>
                   <p class="text-slate-600">ยืม: ${b.borrow_date} | คืน: ${b.due_date}</p>
                   <p class="text-slate-600">วัตถุประสงค์: ${b.purpose}</p>
               </div>`;
      }

      async function renderApprovalLists() {
        if (!state.user || !['admin', 'approver'].includes(state.user.role)) return;

        const pendingUsers = await api.listPendingUsers();
        $('#approvalUsers').innerHTML = pendingUsers.length === 0 ? `<p class="text-slate-500">ไม่มีบัญชีรออนุมัติ</p>`
          : pendingUsers.map(u => `
                <div class="p-3 rounded-lg border border-slate-200">
                    <p class="font-semibold">${u.full_name} (${u.agency})</p>
                    <p class="text-sm text-slate-500">${u.email}</p>
                    <div class="mt-2 flex gap-2">
                        <button onclick="handleApproveUser(${u.id})" class="px-3 py-1 text-sm rounded bg-emerald-500 text-white hover:bg-emerald-600">อนุมัติ</button>
                        <button onclick="handleRejectUser(${u.id})" class="px-3 py-1 text-sm rounded bg-rose-500 text-white hover:bg-rose-600">ไม่อนุมัติ</button>
                    </div>
                </div>`).join('');

        const borrowReqs = await api.listBorrowRequests();
        $('#approvalBorrowList').innerHTML = borrowReqs.length === 0 ? `<p class="text-slate-500">ไม่มีคำขอยืมรออนุมัติ</p>`
          : borrowReqs.map(b => {
            const eq = state.equipment.find(e => e.id === b.equipment_id);
            return `
                <div class="p-3 rounded-lg border border-slate-200">
                    <p><span class="font-semibold">${b.user_name}</span> ขอยืม <span class="font-semibold">${eq?.name}</span></p>
                    <div class="text-sm text-slate-600 bg-slate-50 p-2 rounded-md mt-1">
                      <p><strong>วันที่:</strong> ${b.borrow_date} ถึง ${b.due_date}</p>
                      <p><strong>ผู้ประสานงาน:</strong> ${b.contact_name} (${b.contact_phone})</p>
                      <p><strong>วัตถุประสงค์:</strong> ${b.purpose}</p>
                      ${b.notes ? `<p><strong>หมายเหตุ:</strong> ${b.notes}</p>` : ''}
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button onclick="handleApproveBorrow(${b.id})" class="px-3 py-1 text-sm rounded bg-emerald-500 text-white hover:bg-emerald-600">อนุมัติ</button>
                        <button onclick="handleRejectBorrow(${b.id})" class="px-3 py-1 text-sm rounded bg-rose-500 text-white hover:bg-rose-600">ไม่อนุมัติ</button>
                    </div>
                </div>`}).join('');

        const repairReqs = await api.listRepairRequests();
        $('#approvalRepairList').innerHTML = repairReqs.length === 0 ? `<p class="text-slate-500">ไม่มีคำขอซ่อมรออนุมัติ</p>`
          : repairReqs.map(r => `
                <div class="p-3 rounded-lg border border-slate-200">
                    <p>คำขอซ่อม <span class="font-semibold">${r.equipment_name}</span></p>
                    <p class="text-sm text-slate-500">อาการ: ${r.damage_description}</p>
                    <div class="mt-2 flex gap-2">
                        <button onclick="handleApproveRepair(${r.id})" class="px-3 py-1 text-sm rounded bg-emerald-500 text-white hover:bg-emerald-600">อนุมัติ</button>
                        <button onclick="handleRejectRepair(${r.id})" class="px-3 py-1 text-sm rounded bg-rose-500 text-white hover:bg-rose-600">ไม่อนุมัติ</button>
                    </div>
                </div>`).join('');
      }

      async function renderTechnicianQueues() {
        if (!state.user || !['admin', 'technician'].includes(state.user.role)) return;

        // Delivery Queue
        const deliveryQueue = await api.queueForDelivery();
        $('#techDeliveryQueue').innerHTML = deliveryQueue.length === 0 ? `<p class="text-slate-500">ไม่มีรายการรอส่งมอบ</p>`
          : deliveryQueue.map(b => {
            const eq = state.equipment.find(e => e.id === b.equipment_id);
            return `
                <div class="p-3 rounded-lg border border-slate-200 text-sm">
                    <p>ส่งมอบ <span class="font-semibold">${eq.name}</span></p>
                    <p class="text-slate-600">ให้กับ: ${b.user_name}</p>
                    <button onclick="handlePreDeliveryCheck(${b.id})" class="mt-2 w-full px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 text-xs">ตรวจสภาพก่อนส่งมอบ</button>
                </div>
                `}).join('');

        // Return Queue
        const returnQueue = await api.queueForReturn();
        $('#techReturnQueue').innerHTML = returnQueue.length === 0 ? `<p class="text-slate-500">ไม่มีรายการรอตรวจสภาพ</p>`
          : returnQueue.map(b => {
            const eq = state.equipment.find(e => e.id === b.equipment_id);
            return `
                    <div class="p-3 rounded-lg border border-slate-200 text-sm">
                        <p><span class="font-semibold">${b.user_name}</span> คืน <span class="font-semibold">${eq?.name}</span></p>
                        <p class="text-slate-600">วันที่ยืม: ${b.borrow_date}</p>
                        <button onclick="handlePostReturnCheck(${b.id})" class="mt-2 w-full px-3 py-1 rounded bg-orange-500 text-white hover:bg-orange-600 text-xs">ตรวจสภาพหลังส่งคืน</button>
                    </div>`;
          }).join('');

        // Repair List
        const repairs = await api.listRepairs();
        $('#repairList').innerHTML = repairs.length === 0 ? `<div class="text-slate-500 text-center">ไม่มีประวัติการซ่อม</div>`
          : repairs.map(r => {
            let statusText, statusColor;
            switch (r.status) {
              case 'pending_repair_approval': statusText = 'รออนุมัติซ่อม'; statusColor = 'bg-yellow-100 text-yellow-800'; break;
              case 'repair_approved': statusText = 'กำลังซ่อม'; statusColor = 'bg-blue-100 text-blue-800'; break;
              case 'repair_rejected': statusText = 'ไม่อนุมัติซ่อม'; statusColor = 'bg-red-100 text-red-800'; break;
              case 'completed': statusText = 'ซ่อมเสร็จ'; statusColor = 'bg-green-100 text-green-800'; break;
              default: statusText = 'ไม่ทราบสถานะ'; statusColor = 'bg-gray-100 text-gray-800';
            }
            const canComplete = r.status === 'repair_approved' && (state.user.role === 'technician' || state.user.role === 'admin');
            return `
                    <div class="p-3 rounded-lg border border-slate-200 text-sm">
                        <div class="flex justify-between items-start">
                           <span class="font-semibold">${r.equipment_name}</span>
                           <span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">${statusText}</span>
                        </div>
                        <p class="text-slate-600">อาการ: ${r.damage_description}</p>
                        ${canComplete ? `<button onclick="handleCompleteRepairClick(${r.id})" class="mt-2 px-3 py-1 text-xs rounded bg-indigo-500 text-white hover:bg-indigo-600">บันทึกการซ่อม</button>` : ''}
                        ${r.status === 'completed' ? `<div class="text-xs mt-1 text-slate-500 bg-slate-50 p-1.5 rounded"><strong>รายละเอียด:</strong> ${r.repair_details || '-'} | <strong>ค่าซ่อม:</strong> ${r.cost || 0} บาท</div>` : ''}
                    </div>`;
          }).join('');
      }

      async function renderReports() {
        if (!state.user || !['admin', 'approver'].includes(state.user.role)) return;
        const summary = await api.reportOverview();
        $('#reportCards').innerHTML = summary.map(item => `
                <div class="rounded-xl p-4 ${item.color}">
                    <div class="text-sm font-medium">${item.label}</div>
                    <div class="text-3xl font-bold mt-1">${item.value}</div>
                </div>
            `).join('');
      }

      // =================================================================================
      // EVENT HANDLERS (ฟังก์ชันจัดการการกระทำของผู้ใช้)
      // =================================================================================

      // Approvals
      window.handleApproveUser = async (id) => { try { await api.approveUser(id); toast('อนุมัติผู้ใช้สำเร็จ'); fullRender(); } catch (e) { toast(e.message, true); } };
      window.handleRejectUser = async (id) => { try { await api.rejectUser(id); toast('ปฏิเสธผู้ใช้เรียบร้อย'); fullRender(); } catch (e) { toast(e.message, true); } };
      window.handleApproveBorrow = async (id) => { try { await api.approveBorrow(id); toast('อนุมัติการยืมสำเร็จ (รอช่างตรวจ)'); fullRender(); } catch (e) { toast(e.message, true); } };
      window.handleRejectBorrow = async (id) => { try { await api.rejectBorrow(id); toast('ปฏิเสธการยืมเรียบร้อย'); fullRender(); } catch (e) { toast(e.message, true); } };
      window.handleApproveRepair = async (id) => { try { await api.approveRepair(id); toast('อนุมัติการซ่อมสำเร็จ'); fullRender(); } catch (e) { toast(e.message, true); } };
      window.handleRejectRepair = async (id) => { try { await api.rejectRepair(id); toast('ปฏิเสธการซ่อมเรียบร้อย'); fullRender(); } catch (e) { toast(e.message, true); } };

      // Technicians & Admin

      function getChecklistHTML(formId, checklist) {
        return checklist.map(item => `
                <div class="grid grid-cols-3 items-center border-b py-2">
                    <label for="${formId}-${item.id}" class="text-sm text-slate-700 col-span-2">${item.label}</label>
                    <div class="flex items-center justify-end gap-4">
                         <label class="flex items-center gap-1">
                            <input type="radio" name="${item.id}" value="ok" class="h-4 w-4" checked> <span class="text-sm">ปกติ</span>
                         </label>
                         <label class="flex items-center gap-1">
                            <input type="radio" name="${item.id}" value="faulty" class="h-4 w-4"> <span class="text-sm">ผิดปกติ</span>
                         </label>
                    </div>
                </div>
            `).join('');
      }

      window.handlePreDeliveryCheck = (borrowId) => {
        const borrow = state.borrows.find(b => b.id === borrowId);
        const equip = state.equipment.find(e => e.id === borrow.equipment_id);
        const inspectionChecklist = [
          { id: 'check_exterior', label: '1. ตรวจสอบสภาพภายนอก' },
          { id: 'check_fuel_tank', label: '2. ตรวจสอบถังน้ำมันเชื้อเพลิง' },
          { id: 'check_carburetor', label: '3. ตรวจสอบคาร์บูเรเตอร์' },
          { id: 'check_spark_plug', label: '4. ตรวจสอบหัวเทียน' },
          { id: 'check_battery', label: '5. ตรวจสอบแบตเตอรี่' },
          { id: 'check_chem_pipe', label: '6. ตรวจสอบท่อน้ำยาเคมี' },
          { id: 'check_nozzle_system', label: '7. ตรวจสอบระบบพ่น' }
        ];

        const content = `
                <form id="preDeliveryForm" data-id="${borrowId}">
                    <p class="text-sm text-slate-600 mb-3">ตรวจสภาพ <strong>${equip.name}</strong> ก่อนส่งมอบให้ <strong>${borrow.user_name}</strong></p>
                    <div class="bg-slate-50 p-3 rounded-lg">${getChecklistHTML('preDeliveryForm', inspectionChecklist)}</div>
                     <textarea name="notes" rows="2" placeholder="หมายเหตุเพิ่มเติม" class="mt-3 w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                </form>
            `;
        const actions = `
                <button type="button" onclick="handleReportFault(${borrowId})" class="px-4 py-2 rounded-lg bg-amber-500 text-white hover:bg-amber-600">พบปัญหา/เปลี่ยนเครื่อง</button>
                <button type="submit" form="preDeliveryForm" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ยืนยันส่งมอบ (เครื่องปกติ)</button>
            `;
        showModal('ตรวจสภาพก่อนส่งมอบ', content, actions);
      };

      window.handleReportFault = (borrowId) => {
        const availableEquip = state.equipment.filter(e => e.status === 'available');
        const content = `
                <form id="replaceEquipForm" data-id="${borrowId}">
                    <p class="text-sm text-slate-600 mb-3">เครื่องเดิมจะถูกส่งซ่อม กรุณาเลือกเครื่องใหม่เพื่อทดแทน</p>
                    <select name="new_equip_id" class="w-full px-3 py-2 rounded-lg border border-slate-300" required>
                        <option value="">-- เลือกเครื่องทดแทน --</option>
                        ${availableEquip.map(e => `<option value="${e.id}">${e.name} (S/N: ${e.serial})</option>`).join('')}
                    </select>
                </form>
            `;
        const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">ยกเลิก</button>
                             <button type="submit" form="replaceEquipForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">ยืนยันการเปลี่ยนเครื่อง</button>`;
        showModal('เปลี่ยนเครื่องทดแทน', content, actions);
      };

      window.handlePostReturnCheck = (id) => {
        const inspectionChecklist = [
          { id: 'check_exterior', label: '1. ตรวจสอบสภาพภายนอก' },
          { id: 'check_fuel_tank', label: '2. ตรวจสอบถังน้ำมันเชื้อเพลิง' },
          { id: 'check_carburetor', label: '3. ตรวจสอบคาร์บูเรเตอร์' },
          { id: 'check_spark_plug', label: '4. ตรวจสอบหัวเทียน' },
          { id: 'check_battery', label: '5. ตรวจสอบแบตเตอรี่' },
          { id: 'check_chem_pipe', label: '6. ตรวจสอบท่อน้ำยาเคมี' },
          { id: 'check_nozzle_system', label: '7. ตรวจสอบระบบพ่น' }
        ];
        const content = `
                <form id="postReturnForm" data-id="${id}">
                    <div class="bg-slate-50 p-3 rounded-lg">${getChecklistHTML('postReturnForm', inspectionChecklist)}</div>
                    <label class="block text-sm font-medium text-slate-700 mt-4">สรุปผล</label>
                    <select name="isDamaged" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                        <option value="false">ปกติ</option>
                        <option value="true">ชำรุด</option>
                    </select>
                    <textarea name="notes" rows="2" placeholder="หมายเหตุ (หากชำรุด กรุณาระบุอาการ)" class="mt-2 w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                </form>
            `;
        const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">ยกเลิก</button>
                             <button type="submit" form="postReturnForm" class="px-4 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700">บันทึกผล</button>`;
        showModal('ตรวจสภาพหลังส่งคืน', content, actions);
      };

      window.handleCompleteRepairClick = (id) => {
        const repair = state.repairs.find(r => r.id === id);
        const content = `
                 <form id="completeRepairForm" data-id="${id}" class="space-y-3 text-sm">
                    <div class="grid grid-cols-2 gap-3">
                         <input name="repair_date" type="date" value="${new Date().toISOString().slice(0, 10)}" required class="w-full px-3 py-2 rounded-lg border border-slate-200">
                         <input name="repair_by" required placeholder="ผู้ดำเนินการซ่อม" value="${state.user.name}" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    </div>
                    <div>
                        <label class="font-medium">อาการชำรุด:</label>
                        <p class="p-2 bg-slate-50 rounded-md">${repair.damage_description}</p>
                    </div>
                    <textarea name="repair_details" required rows="3" placeholder="การดำเนินการซ่อม" class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                    <textarea name="parts_used" rows="2" placeholder="รายการวัสดุ/อะไหล่ที่ใช้" class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                    <input name="cost" type="number" placeholder="จำนวนเงิน (บาท)" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                 </form>
            `;
        const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">ยกเลิก</button>
                             <button type="submit" form="completeRepairForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">บันทึกการซ่อม</button>`;
        showModal('บันทึกรายละเอียดการซ่อม', content, actions);
      };

      window.handleAssessmentClick = (id, name) => {
        const content = `
                <form id="assessmentForm" data-id="${id}" class="text-sm">
                    <p class="text-base text-slate-600 mb-3">สำหรับ: <strong>${name}</strong></p>
                    <div class="grid md:grid-cols-2 gap-x-6 gap-y-3">
                        <div>
                            <label class="font-medium">สภาพภายนอกเครื่องพ่น</label>
                            <div class="flex gap-4 mt-1"><label><input type="radio" name="exterior_condition" value="new"> ใหม่</label><label><input type="radio" name="exterior_condition" value="mid" checked> ปานกลาง</label><label><input type="radio" name="exterior_condition" value="old"> เก่า</label></div>
                        </div>
                        <div>
                            <label class="font-medium">การติดเครื่องยนต์</label>
                            <div class="flex gap-4 mt-1"><label><input type="radio" name="engine_start" value="easy" checked> ติดง่าย</label><label><input type="radio" name="engine_start" value="hard"> ติดยาก</label></div>
                        </div>
                        <div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-4 gap-3 bg-slate-50 p-2 rounded-md">
                            <label class="font-medium col-span-full">ความสะอาดภายใน</label>
                            <label><input type="checkbox" name="clean_pipe"> ท่อพ่น</label>
                            <label><input type="checkbox" name="clean_chem_line"> สายส่งน้ำยา</label>
                            <label><input type="checkbox" name="clean_gas_tank"> ถังเบนซิน</label>
                            <label><input type="checkbox" name="clean_chem_tank"> ถังเคมี</label>
                        </div>
                         <div class="md:col-span-2">
                             <h4 class="font-semibold mt-2">ข้อมูลสารเคมีที่ทดสอบ</h4>
                             <div class="grid sm:grid-cols-3 gap-3 mt-1">
                                <input name="chem_name" placeholder="ชื่อสารเคมี" class="w-full px-3 py-2 rounded-lg border">
                                <input name="chem_concentration" placeholder="ความเข้มข้น (%)" class="w-full px-3 py-2 rounded-lg border">
                                <input name="chem_mix_ratio" placeholder="อัตราส่วนผสม" class="w-full px-3 py-2 rounded-lg border">
                             </div>
                        </div>
                         <div class="md:col-span-2">
                             <h4 class="font-semibold mt-2">สรุปผลการทดสอบ</h4>
                             <div class="grid sm:grid-cols-2 gap-3 mt-1">
                                <input name="result_temp" placeholder="อุณหภูมิปลายท่อ (°C)" class="w-full px-3 py-2 rounded-lg border">
                                <input name="result_flow_rate" placeholder="อัตราการไหลเฉลี่ย (มล./นาที)" class="w-full px-3 py-2 rounded-lg border">
                             </div>
                        </div>
                        <textarea name="notes" placeholder="ข้อเสนอแนะ" rows="2" class="w-full px-3 py-2 rounded-lg border md:col-span-2"></textarea>
                    </div>
                </form>
            `;
        const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">ยกเลิก</button>
                             <button type="submit" form="assessmentForm" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">บันทึกผลประเมิน</button>`;
        showModal('แบบรายงานการประเมินมาตรฐานเครื่องพ่น', content, actions);
      };

      window.handleAddEquipmentClick = () => {
        const content = `
                <form id="addEquipForm" class="space-y-3">
                    <input name="name" required placeholder="ชื่อ/ยี่ห้อ" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <input name="serial" required placeholder="เลขที่/รหัส" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                </form>
            `;
        const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">ยกเลิก</button>
                             <button type="submit" form="addEquipForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">เพิ่มอุปกรณ์</button>`;
        showModal('เพิ่มอุปกรณ์ใหม่', content, actions);
      };

      window.handleEditEquipmentClick = (id) => {
        const equip = state.equipment.find(e => e.id === id);
        const content = `
                <form id="editEquipForm" data-id="${id}" class="space-y-3">
                    <input name="name" required value="${equip.name}" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <input name="serial" required value="${equip.serial}" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                </form>
            `;
        const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">ยกเลิก</button>
                             <button type="submit" form="editEquipForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">บันทึก</button>`;
        showModal('แก้ไขข้อมูลอุปกรณ์', content, actions);
      };

      window.handleDeleteEquipmentClick = (id) => {
        if (confirm('คุณต้องการลบอุปกรณ์นี้ใช่หรือไม่?')) {
          try {
            api.deleteEquipment(id);
            toast('ลบอุปกรณ์สำเร็จ');
            fullRender();
          } catch (e) {
            toast(e.message, true);
          }
        }
      };

      // Form Submissions
      async function handleDynamicFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const id = parseInt(form.dataset.id);
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const checklistData = Object.fromEntries(Array.from(formData.keys()).filter(k => k.startsWith('check_')).map(k => [k, formData.get(k)]));

        try {
          switch (form.id) {
            case 'preDeliveryForm':
              await api.performPreDeliveryCheck(id, false, null, checklistData);
              toast('บันทึกผลและส่งมอบเรียบร้อย');
              break;
            case 'replaceEquipForm':
              await api.performPreDeliveryCheck(id, true, parseInt(data.new_equip_id), checklistData);
              toast('เปลี่ยนเครื่องและบันทึกผลเรียบร้อย');
              break;
            case 'postReturnForm':
              await api.techInspectReturn(id, data.isDamaged === 'true', data.notes, checklistData);
              toast('บันทึกผลการตรวจสภาพสำเร็จ');
              break;
            case 'completeRepairForm':
              await api.completeRepair(id, data);
              toast('บันทึกรายละเอียดการซ่อมเรียบร้อย');
              break;
            case 'assessmentForm':
              await api.createAssessment({ equipment_id: id, ...data });
              toast('บันทึกผลการประเมินสำเร็จ');
              break;
            case 'addEquipForm':
              await api.addEquipment(data);
              toast('เพิ่มอุปกรณ์สำเร็จ');
              break;
            case 'editEquipForm':
              await api.updateEquipment(id, data);
              toast('แก้ไขข้อมูลสำเร็จ');
              break;
          }
          hideModal();
          fullRender();
        } catch (err) {
          toast(err.message, true);
        }
      }
      async function handleLogin(e) { e.preventDefault(); const d = Object.fromEntries(new FormData(e.target).entries()); try { const user = await api.login(d.email, d.password); state.user = user; localStorage.setItem('yonchuw_user', JSON.stringify(user)); toast(`ยินดีต้อนรับ, ${user.name}`); show('dashboard'); fullRender(); } catch (err) { toast(err.message, true); } e.target.reset(); }
      async function handleRegister(e) { e.preventDefault(); const d = Object.fromEntries(new FormData(e.target).entries()); if (d.password.length < 6) { toast('รหัสผ่านต้องมี 6 ตัวอักษรขึ้นไป', true); return; } try { const res = await api.register(d); toast(res.message); show('loginPage'); } catch (err) { toast(err.message, true); } e.target.reset(); }
      function handleLogout() { state.user = null; localStorage.removeItem('yonchuw_user'); toast('ออกจากระบบสำเร็จ'); show('home'); applyRoleVisibility(); }
      async function handleBorrowSubmit(e) { e.preventDefault(); const btn = e.target.querySelector('button'); const formData = new FormData(e.target); try { btn.disabled = true; const payload = { equipment_id: parseInt(formData.get('borrowEquipSelect')), ...Object.fromEntries(formData.entries()), user_id: state.user.id }; if (!payload.equipment_id || !payload.borrow_date || !payload.purpose || !payload.contact_name) { throw new Error('กรุณากรอกข้อมูลสำคัญให้ครบถ้วน'); } await api.createBorrow(payload); toast('ส่งคำขอยืมสำเร็จ'); e.target.reset(); fullRender(); } catch (err) { toast(err.message, true); } finally { btn.disabled = false; } }

      // =================================================================================
      // INITIALIZATION (ฟังก์ชันเริ่มต้นและตั้งค่า)
      // =================================================================================
      function applyRoleVisibility() {
        const loggedIn = !!state.user;
        $('#btnLogin').classList.toggle('hidden', loggedIn);
        $('#btnRegister').classList.toggle('hidden', loggedIn);
        $('#userInfo').classList.toggle('hidden', !loggedIn);
        $('#userInfo').classList.toggle('flex', loggedIn);

        $$('.tab-btn').forEach(b => b.classList.add('hidden'));

        if (loggedIn) {
          $('#userNameDisplay').textContent = state.user.name;
          const role = state.user.role;

          if (role === 'admin') {
            $$('.tab-btn').forEach(b => b.classList.remove('hidden'));
          } else if (role === 'user') {
            $('[data-tab="equipmentTab"]').classList.remove('hidden');
            $('[data-tab="borrowTab"]').classList.remove('hidden');
          } else if (role === 'approver') {
            $('[data-tab="approvalTab"]').classList.remove('hidden');
            $('[data-tab="reportTab"]').classList.remove('hidden');
          } else if (role === 'technician') {
            $('[data-tab="equipmentTab"]').classList.remove('hidden');
            $('[data-tab="techTab"]').classList.remove('hidden');
            $('[data-tab="assessmentTab"]').classList.remove('hidden');
          }

          $('#btnAddEquipDash').classList.toggle('hidden', role !== 'admin');

        }
      }

      function setupEventListeners() {
        $('#startBtn').addEventListener('click', () => state.user ? show('dashboard') : show('loginPage'));
        $$('.tab-btn').forEach(btn => btn.addEventListener('click', () => setTabs(btn.dataset.tab)));
        $('#borrowHistoryFilter').addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') {
            $$('#borrowHistoryFilter button').forEach(b => b.classList.remove('bg-white', 'shadow'));
            e.target.classList.add('bg-white', 'shadow');
            renderMyBorrows();
          }
        });
        $('#btnAddEquipDash').addEventListener('click', handleAddEquipmentClick);

        // Re-bind other listeners as they are fine
        $('#btnLogin').addEventListener('click', () => show('loginPage'));
        $('#btnRegister').addEventListener('click', () => show('registerPage'));
        $('#goRegister').addEventListener('click', (e) => { e.preventDefault(); show('registerPage'); });
        $('#browseBtn').addEventListener('click', () => show('equipmentShowcase'));
        $('#backFromEquip').addEventListener('click', () => show('home'));
        $('#backFromLogin').addEventListener('click', () => show('home'));
        $('#backFromRegister').addEventListener('click', () => show('loginPage'));
        $('#btnLogout').addEventListener('click', handleLogout);
        $('#loginForm').addEventListener('submit', handleLogin);
        $('#registerForm').addEventListener('submit', handleRegister);
        $('#borrowForm').addEventListener('submit', handleBorrowSubmit);
        $('#modalClose').addEventListener('click', hideModal);
        $('#modal').addEventListener('click', (e) => { if (e.target.id === 'modal') hideModal() });
        document.addEventListener('submit', (e) => {
          if (['preDeliveryForm', 'postReturnForm', 'completeRepairForm', 'assessmentForm', 'addEquipForm', 'editEquipForm', 'replaceEquipForm'].includes(e.target.id)) {
            handleDynamicFormSubmit(e);
          }
        });
        $('#equipSearch').addEventListener('input', () => renderEquipmentLists(false));
        $('#equipFilter').addEventListener('change', () => renderEquipmentLists(false));
        $('#dashEquipSearch').addEventListener('input', () => renderEquipmentLists(true));
        $('#dashEquipFilter').addEventListener('change', () => renderEquipmentLists(true));
        $('#borrowDate').addEventListener('change', (e) => {
          if (e.target.value) { const d = new Date(e.target.value); d.setDate(d.getDate() + 7); $('#dueDate').value = d.toISOString().slice(0, 10); } else { $('#dueDate').value = ''; }
        });
      }

      function populateBorrowSelect() {
        const select = $('#borrowEquipSelect');
        const availableEquip = state.equipment.filter(e => e.status === 'available');
        select.innerHTML = `<option value="">-- เลือกอุปกรณ์ --</option>` + availableEquip.map(e => `<option value="${e.id}">${e.name} (S/N: ${e.serial})</option>`).join('');
      }

      function fullRender() {
        applyRoleVisibility();
        if (state.user) {
          const role = state.user.role;
          let defaultTab = 'equipmentTab';
          if (role === 'approver') defaultTab = 'approvalTab';
          if (role === 'user') defaultTab = 'borrowTab';
          if (role === 'technician') defaultTab = 'techTab';

          const currentActiveTab = $('.tab-btn.bg-white')?.dataset?.tab;
          if (!currentActiveTab || $(`[data-tab="${currentActiveTab}"]`).classList.contains('hidden')) {
            setTabs(defaultTab);
          }

          renderEquipmentSummary();
          renderMyBorrows();
          renderApprovalLists();
          renderTechnicianQueues();
          renderReports();
          populateBorrowSelect();
        }
        renderEquipmentLists();
      }

      function init() {
        const savedUser = localStorage.getItem('yonchuw_user');
        if (savedUser) {
          state.user = JSON.parse(savedUser);
          show('dashboard');
        } else {
          show('home');
        }
        setupEventListeners();
        fullRender();
      }

      init(); // Start the application
    });
  </script>
</body>

</html>