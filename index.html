<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Chosen Palette: Indigo Twilight Gradient -->
    <!-- Application Structure Plan: The application uses a task-oriented Single Page Application (SPA) model. The structure is designed for a clear user flow: a public landing page for introduction, dedicated login/register screens, and a role-based dashboard for authenticated users. The dashboard utilizes a tabbed navigation system to logically separate distinct user functions (e.g., equipment management, borrowing tasks, technician queues, approvals, reporting). This structure was chosen because it cleanly separates contexts, prevents information overload, and allows users to focus on specific tasks based on their roles. Interactions like creating requests or performing inspections are handled in modals to maintain context and avoid page reloads, creating a seamless and efficient user experience. -->
    <!-- Visualization & Content Choices: 
        - Equipment/User Summaries -> Goal: Inform -> Viz: Key Stats Cards (HTML/Tailwind) -> Interaction: Static -> Justification: Provides a quick, at-a-glance overview of system status.
        - Monthly Borrowing Data -> Goal: Show Change -> Viz: Bar Chart (Chart.js/Canvas) -> Interaction: Static -> Justification: Effectively visualizes trends in borrowing activity over time.
        - Equipment/User/Task Lists -> Goal: Organize & Act -> Viz: Interactive Card/Table Lists (HTML/Tailwind) -> Interaction: Search, Filter, Sort, Click actions -> Justification: Allows users to efficiently find information and perform tasks directly from the list view.
        - Complex Workflows (e.g., Inspections, Repair Logs) -> Goal: Guide User Process -> Viz: Form Modals (HTML/Tailwind) -> Interaction: User Input -> Justification: Breaks down complex tasks into manageable, focused steps without cluttering the main UI.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <title>Yonchuw ‚Äì ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á ‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Thai', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
        }
        .bg-grad {
            background: radial-gradient(1200px 600px at 80% -10%, rgba(79, 70, 229, .18), transparent 60%), linear-gradient(135deg, #0ea5e9 0%, #2563eb 50%, #7c3aed 100%);
        }
        .glass {
            backdrop-filter: saturate(140%) blur(10px);
            background: rgba(255, 255, 255, 0.08);
        }
        .card {
            background: rgba(255, 255, 255, 0.96);
        }
        .fade-in {
            animation: fade .35s ease-out;
        }
        @keyframes fade {
            from {
                opacity: 0;
                transform: translateY(6px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chip {
            background: rgba(99, 102, 241, .12);
            color: #4338ca;
            font-weight: 500;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .prose { color: #334155; }
        .prose h1, .prose h2, .prose h3, .prose h4 { color: #1e293b; }
        .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose strong { color: #1e293b; }
        .notification-dot::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ef4444;
            border: 2px solid white;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        @media (max-width: 767px) {
            .max-w-7xl, .max-w-xl, .max-w-md, .max-w-4xl { padding-left: 1rem !important; padding-right: 1rem !important; }
            .md-stack > * { width: 100% !important; }
            .md-stack { flex-direction: column !important; align-items: stretch !important; }
            .grid-mobile-1 { grid-template-columns: 1fr !important; }
            header .flex.justify-between { flex-direction: row !important; align-items: center !important; }
        }
    </style>
</head>
<body class="min-h-screen bg-grad text-white transition-all duration-300">
    <header class="sticky top-0 z-30 glass">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="show('home')">
                <div class="w-9 h-9 rounded-xl bg-white/20 flex items-center justify-center">
                    <span class="text-2xl text-white">üîÑ</span>
                </div>
                <div>
                    <p class="font-semibold text-lg">Yonchuw</p>
                    <p class="text-white/80 text-xs -mt-0.5">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="notificationArea" class="relative hidden">
                    <button id="notificationBtn" class="p-2 rounded-full hover:bg-white/20 transition-colors text-2xl">
                       <span>üîî</span>
                    </button>
                    <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg text-slate-800 z-50 text-sm">
                        <div class="p-3 font-semibold border-b">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                        <div id="notificationList" class="p-2 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
                <nav class="hidden md:flex items-center gap-2" id="nav-actions">
                    <button id="btnLogin" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="btnRegister" class="px-4 py-2 rounded-lg bg-white text-slate-900 font-semibold hover:opacity-90 transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                    <div id="userInfo" class="hidden items-center gap-3">
                        <span id="userNameDisplay" class="text-sm font-medium"></span>
                        <button id="btnLogout" class="px-4 py-2 rounded-lg bg-red-500/20 text-red-100 hover:bg-red-500/40 transition text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </nav>
                <button id="hamburgerBtn" class="md:hidden p-2 rounded-lg bg-white/10 hover:bg-white/20 hidden text-2xl">
                    <span>‚ò∞</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <section id="home" class="fade-in">
            <div class="grid md:grid-cols-2 gap-8 items-start md-stack">
                <div>
                    <h1 class="text-4xl sm:text-5xl font-bold leading-tight tracking-tighter">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á ‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</h1>
                    <p class="mt-4 text-lg text-white/90">‡∏•‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
                    <div class="mt-8 flex flex-wrap gap-4">
                        <button id="startBtn" class="px-6 py-3 rounded-xl bg-white text-slate-900 font-semibold hover:opacity-90 transition-transform hover:scale-105">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                        <button id="browseBtn" class="px-6 py-3 rounded-xl bg-white/10 hover:bg-white/20 transition">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</button>
                    </div>
                    <div class="mt-6 flex items-center gap-3 text-sm">
                        <span class="chip px-3 py-1 rounded-full">Responsive</span>
                        <span class="chip px-3 py-1 rounded-full">Role-based</span>
                        <span class="chip px-3 py-1 rounded-full">Real-time</span>
                    </div>
                </div>
                <div class="card rounded-2xl p-6 text-slate-900 shadow-xl">
                    <div class="flex items-center justify-between">
                        <p class="font-semibold">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠</p>
                        <span class="text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 font-medium">Demo</span>
                    </div>
                    <ol class="mt-4 space-y-2.5 text-sm text-slate-700 list-decimal list-inside">
                        <li><strong>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</strong> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‚Üí ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Äù</li>
                        <li><strong>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Üí ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ</li>
                        <li><strong>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°:</strong> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</li>
                        <li><strong>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°:</strong> ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠ ‚Üí ‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</li>
                        <li><strong>‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏ä‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ß‡πà‡∏≤ ‚Äú‡πÄ‡∏™‡∏µ‡∏¢/‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‚Äù</li>
                        <li><strong>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°:</strong> ‡∏´‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢ ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏° ‚Üí ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏° ‚Üí ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à ‚Üí ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‚Äú‡∏ß‡πà‡∏≤‡∏á‚Äù</li>
                    </ol>
                    <div class="mt-5 p-3 rounded-lg bg-slate-50 border text-sm text-slate-600">
                        <strong>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: password)</strong>
                        <ul class="list-disc list-inside mt-1">
                            <li>admin@example.com (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)</li>
                            <li>approver@example.com (‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</li>
                            <li>tech@example.com (‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ)</li>
                            <li>user@example.com (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="equipmentShowcase" class="hidden fade-in">
            <div class="flex items-center justify-between mb-6">
                <button id="backFromEquip" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
                    <span class="text-lg">‚Üê</span>
                    ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                </button>
                <h2 class="text-xl font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div></div>
            </div>
            <div class="card rounded-2xl p-6 text-slate-900">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex items-center gap-2">
                        <input id="equipSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ Serial" class="px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <select id="equipFilter" class="px-3 py-2 rounded-lg border border-slate-200">
                            <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="available">‡∏ß‡πà‡∏≤‡∏á</option>
                            <option value="borrowed">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</option>
                            <option value="under_maintenance">‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option>
                        </select>
                    </div>
                    <button id="btnAddEquip" class="hidden px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
                </div>
                <div id="equipList" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4 grid-mobile-1"></div>
            </div>
        </section>

        <section id="loginPage" class="hidden fade-in">
            <div class="max-w-md mx-auto card rounded-2xl p-8 text-slate-900 shadow-xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <button id="backFromLogin" class="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">‡∏Å‡∏•‡∏±‡∏ö</button>
                </div>
                <form id="loginForm" class="mt-6 space-y-4">
                    <input name="email" type="email" required placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <input name="password" type="password" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <button type="submit" class="w-full px-4 py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>
                <p class="mt-4 text-sm text-center text-slate-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a href="#" id="goRegister" class="font-medium text-indigo-600 hover:underline">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a></p>
            </div>
        </section>

        <section id="registerPage" class="hidden fade-in">
            <div class="max-w-xl mx-auto card rounded-2xl p-8 text-slate-900 shadow-xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
                    <button id="backFromRegister" class="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">‡∏Å‡∏•‡∏±‡∏ö</button>
                </div>
                <form id="registerForm" class="mt-6 grid sm:grid-cols-2 gap-4">
                    <input name="full_name" required placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <input name="agency" required placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <input name="phone" type="tel" required placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <input name="email" type="email" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <textarea name="address" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" rows="2" class="sm:col-span-2 px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea>
                    <input name="password" type="password" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)" minlength="8" class="sm:col-span-2 px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <button type="submit" class="sm:col-span-2 px-4 py-3 rounded-lg bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>
                <div class="mt-4 text-sm text-amber-800 bg-amber-50 border border-amber-200 rounded-lg p-3">
                    <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏´‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äú‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Äù ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                </div>
            </div>
        </section>

        <section id="dashboard" class="hidden fade-in">
            <div id="demoModeBanner" class="hidden bg-yellow-400 text-yellow-900 p-3 mb-6 rounded-lg flex items-center justify-between shadow-lg">
                <div class="flex items-center gap-2">
                    <span class="text-xl">‚úì</span>
                    <span class="font-semibold text-sm">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (Simulation Mode)</span>
                </div>
                <button id="exitDemoBtn" class="px-3 py-1 rounded-md bg-white/50 hover:bg-white/80 text-sm font-medium">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            </div>

            <div class="mt-4 overflow-x-auto hidden md:block">
                <div id="desktopTabs" class="inline-flex gap-1 bg-white/10 rounded-xl p-1"></div>
            </div>

            <div class="mt-6">
                <div id="equipmentTab" class="tab-content">
                    <div class="grid lg:grid-cols-3 gap-6 grid-mobile-1">
                        <div class="lg:col-span-2 card rounded-2xl p-6 text-slate-900">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
                                <div class="flex items-center gap-2">
                                    <input id="dashEquipSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" class="px-3 py-2 w-32 rounded-lg border border-slate-200">
                                    <select id="dashEquipFilter" class="px-3 py-2 rounded-lg border border-slate-200">
                                        <option value="all">‡∏ß‡πà‡∏≤‡∏á & ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</option>
                                        <option value="available">‡∏ß‡πà‡∏≤‡∏á</option>
                                        <option value="borrowed">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</option>
                                        <option value="under_maintenance">‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option>
                                        <option value="pending_repair_approval">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°</option>
                                    </select>
                                    <button id="btnAddEquipDash" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 hidden">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                                </div>
                            </div>
                            <div id="dashEquipList" class="mt-4 grid sm:grid-cols-2 gap-4 grid-mobile-1"></div>
                        </div>
                        <div class="card rounded-2xl p-6 text-slate-900 space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
                                <div id="equipmentSummary" class="grid grid-cols-2 gap-4 mt-2"></div>
                            </div>
                            <div id="userSummaryContainer">
                                <h3 class="text-lg font-semibold">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                                <div id="userSummary" class="grid grid-cols-2 gap-4 mt-2"></div>
                                <button id="viewAllUsersBtn" class="mt-3 w-full text-center px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="borrowTab" class="hidden tab-content">
                     <div class="card rounded-2xl p-6 text-slate-900" id="borrowFormContainer">
                        <h3 class="text-lg font-semibold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
                        <form id="borrowForm" class="mt-4 space-y-3">
                            <div class="border rounded-lg p-2 max-h-48 overflow-y-auto">
                                <p class="text-sm font-medium mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°:</p>
                                <div id="borrowEquipTypeList" class="space-y-1"></div>
                            </div>
                            <div class="grid sm:grid-cols-2 gap-3">
                                <input type="date" name="borrow_date" id="borrowDate" class="px-3 py-2 rounded-lg border border-slate-200" required>
                                <input type="date" id="dueDate" class="px-3 py-2 rounded-lg border border-slate-200 bg-slate-50" readonly>
                            </div>
                            <input name="purpose" placeholder="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" class="w-full px-3 py-2 rounded-lg border border-slate-200" required>
                            <div class="grid sm:grid-cols-2 gap-3">
                                <input name="contact_name" placeholder="‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô" class="px-3 py-2 rounded-lg border border-slate-200" required>
                                <input name="contact_phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="px-3 py-2 rounded-lg border border-slate-200" required>
                            </div>
                            <textarea name="notes" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á, ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô)" class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                            <button class="w-full px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                        </form>
                        <p class="text-xs text-slate-500 mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</p>
                    </div>
                </div>

                <div id="borrowHistoryTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                         <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h3>
                            <div id="borrowHistoryFilter" class="flex items-center gap-1 bg-slate-100 p-1 rounded-lg">
                                <button data-filter="all" class="px-3 py-1 text-sm rounded-md bg-white shadow">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <button data-filter="borrowed" class="px-3 py-1 text-sm rounded-md">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</button>
                                <button data-filter="returned" class="px-3 py-1 text-sm rounded-md">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
                            </div>
                        </div>
                        <div id="myBorrowsHistory" class="mt-4 space-y-3"></div>
                    </div>
                </div>

                <div id="techTab" class="hidden tab-content">
                    <div class="grid lg:grid-cols-3 gap-6 grid-mobile-1">
                        <div class="card rounded-2xl p-6 text-slate-900">
                            <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</h3>
                            <div id="techDeliveryQueue" class="mt-4 space-y-3"></div>
                        </div>
                        <div class="card rounded-2xl p-6 text-slate-900">
                            <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û (‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô)</h3>
                            <div id="techReturnQueue" class="mt-4 space-y-3"></div>
                        </div>
                        <div class="card rounded-2xl p-6 text-slate-900">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</h3>
                                <button id="exportRepairsBtn" class="px-3 py-1 text-xs rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300">Export</button>
                            </div>
                            <div id="repairList" class="mt-4 space-y-3"></div>
                        </div>
                    </div>
                </div>
                 <div id="repairHistoryTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                         <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                         <div id="allRepairsHistory" class="mt-4 space-y-3"></div>
                    </div>
                </div>

                <div id="approvalTab" class="hidden tab-content">
                    <div class="grid lg:grid-cols-2 gap-6 grid-mobile-1">
                        <div class="card rounded-2xl p-6 text-slate-900">
                            <h3 class="text-lg font-semibold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
                            <div id="approvalUsers" class="mt-3 space-y-3"></div>
                        </div>
                        <div class="card rounded-2xl p-6 text-slate-900">
                            <h3 class="text-lg font-semibold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3>
                            <div id="approvalBorrowList" class="mt-3 space-y-3"></div>
                        </div>
                        <div class="card rounded-2xl p-6 text-slate-900 lg:col-span-2">
                            <h3 class="text-lg font-semibold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</h3>
                            <div id="approvalRepairList" class="mt-3 space-y-3"></div>
                        </div>
                    </div>
                </div>

                <div id="assessmentTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô</h3>
                            <div class="flex items-center gap-2">
                                <select id="assessmentTypeFilter" class="px-3 py-2 rounded-lg border border-slate-200 text-sm">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                </select>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</p>
                        <div id="assessmentEquipList" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4 grid-mobile-1"></div>
                    </div>
                </div>

                <div id="reportTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900 mb-6">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <h3 class="text-lg font-semibold">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                             <div class="flex items-center gap-2">
                                <input type="month" id="reportMonthFilter" class="px-3 py-2 text-sm rounded-lg border border-slate-200">
                                <button id="exportReportsBtn" class="px-4 py-2 text-sm rounded-lg bg-slate-200 text-slate-800 hover:bg-slate-300">Export</button>
                            </div>
                        </div>
                        <div id="reportCards" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-4 grid-mobile-1"></div>
                        <div class="mt-6 grid md:grid-cols-2 gap-6 grid-mobile-1">
                            <div class="chart-container">
                                <canvas id="borrowChart"></canvas>
                            </div>
                             <div class="chart-container">
                                <canvas id="repairCostChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="sidebar" class="fixed inset-0 z-40 md:hidden hidden">
        <div id="sidebarBackdrop" class="absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-300"></div>
        <div id="sidebarContent" class="relative z-10 w-64 bg-slate-800 text-white h-full p-4 flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-semibold text-lg">‡πÄ‡∏°‡∏ô‡∏π</h3>
                <button id="sidebarCloseBtn" class="p-2 text-2xl leading-none">&times;</button>
            </div>
            <nav id="sidebarNav" class="flex flex-col gap-2"></nav>
            <div class="mt-auto pt-6 border-t border-white/10">
                <div id="sidebarUserInfo" class="hidden flex-col items-start gap-1">
                    <span id="sidebarUserNameDisplay" class="text-sm font-semibold"></span>
                    <span id="sidebarUserRoleDisplay" class="text-xs px-2 py-0.5 rounded-full bg-white/10 text-white"></span>
                    <button id="reportProblemBtn" class="mt-4 text-left w-full text-sm text-slate-300 hover:text-white">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="sidebarBtnLogout" class="mt-2 px-4 py-2 rounded-lg bg-red-500/20 text-red-100 hover:bg-red-500/40 transition text-sm w-full">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
                <div id="sidebarLoginActions">
                    <button id="sidebarBtnLogin" class="w-full px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="sidebarBtnRegister" class="mt-2 w-full px-4 py-2 rounded-lg bg-white text-slate-900 font-semibold hover:opacity-90 transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div id="modalContent" class="bg-white rounded-2xl p-6 text-slate-900 w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex items-center justify-between">
                <h3 id="modalTitle" class="text-xl font-bold">Modal Title</h3>
                <button id="modalClose" class="text-2xl leading-none text-slate-400 hover:text-slate-800">&times;</button>
            </div>
            <div id="modalBody" class="mt-4"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 px-5 py-3 rounded-lg text-white text-sm font-medium shadow-lg hidden transition-all duration-300"></div>

    <footer class="text-center py-8 px-4 text-white/60 text-xs">
        <div class="max-w-4xl mx-auto border-t border-white/20 pt-8">
            <p class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏≥‡πÇ‡∏î‡∏¢‡πÅ‡∏°‡∏•‡∏á‡∏ó‡∏µ‡πà 12.4.4</p>
            <p>11 ‡∏ñ‡∏ô‡∏ô‡∏£‡∏∞‡πÅ‡∏á‡∏∞‡∏°‡∏£‡∏£‡∏Ñ‡∏≤ ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡∏≤‡∏á‡∏ô‡∏≤‡∏Ñ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™ 96000</p>
            <p>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: 073-514-960</p>
        </div>
    </footer>

    <script>
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const show = (id) => {
            $$('main section').forEach(s => s.classList.add('hidden'));
            const section = $(`#${id}`);
            if (section) { section.classList.remove('hidden'); }
        };
        const hideModal = () => {
            $('#modal').style.opacity = '0';
            $('#modalContent').classList.add('scale-95');
            setTimeout(() => $('#modal').classList.add('hidden'), 300);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                user: null,
                equipment: [
                    { id: 1, serial: '0334 0418 0044', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 2, serial: '0334 0418 0045', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 3, serial: '0334 0418 0046', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 4, serial: '0334 0418 0047', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 5, serial: '0334 0418 0048', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 6, serial: '0334 0418 0049', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 7, serial: '0334 0418 0050', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 8, serial: '0334 0418 0051', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 9, serial: '0334 0418 0052', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 10, serial: '0334 0418 0061', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2008-10-21', status: 'available', notes: '', price: 2500 },
                    { id: 11, serial: '0334 0418 0062', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2008-10-21', status: 'available', notes: '', price: 2500 },
                    { id: 12, serial: '0334 0418 0063', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2008-10-21', status: 'available', notes: '', price: 2500 },
                    { id: 13, serial: '0334 0418 0087', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2009-07-09', status: 'available', notes: '', price: 2500 },
                    { id: 14, serial: '0334 0418 0088', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2009-07-09', status: 'available', notes: '', price: 2500 },
                    { id: 15, serial: '0334 0418 0089', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2009-07-09', status: 'available', notes: '', price: 2500 },
                    { id: 16, serial: '0334 0461 01160 0106', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2018-01-11', status: 'available', notes: '', price: 2500 },
                    { id: 17, serial: '0334 0461 01160 0107', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2018-01-11', status: 'available', notes: '', price: 2500 },
                    { id: 18, serial: '0334 0461 01160 0108', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2018-01-11', status: 'available', notes: '', price: 2500 },
                    { id: 19, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0863 0124', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2020-10-19', status: 'borrowed', notes: '', price: 3200 },
                    { id: 20, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0863 0125', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2020-10-19', status: 'available', notes: '', price: 3200 },
                    { id: 21, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0863 0126', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2020-10-19', status: 'available', notes: '', price: 3200 },
                    { id: 22, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0863 0127', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2020-10-19', status: 'available', notes: '', price: 3200 },
                    { id: 23, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0465 0140', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2022-09-28', status: 'available', notes: '', price: 3200 },
                    { id: 24, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0465 0141', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2022-09-28', status: 'available', notes: '', price: 3200 },
                    { id: 25, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0465 0142', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2022-09-28', status: 'available', notes: '', price: 3200 },
                    { id: 26, serial: '51 6640 007 00005 (67)', name: 'Micron CS10', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2024-05-14', status: 'available', notes: '', price: 15000 },
                    { id: 27, serial: '0332 048 0001 (8551)', name: 'SWING FOG SN 11 P', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '1997-06-13', status: 'available', notes: '', price: 45000 },
                    { id: 28, serial: '0332 048 0001 (8666)', name: 'SWING FOG SN 50', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '1997-06-13', status: 'available', notes: '', price: 45000 },
                    { id: 29, serial: '0332 012.4 0010 (NR070542604)', name: 'IGEBA PORT 123 ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2006-02-18', status: 'available', notes: '', price: 68000 },
                    { id: 30, serial: '0332 012.4 0011 (NR070545004)', name: 'IGEBA PORT 123 ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2006-02-18', status: 'under_maintenance', notes: '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà', price: 68000 },
                    { id: 31, serial: '0332 012.4 0012', name: 'SWING FOG SN50', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2006-11-30', status: 'available', notes: '', price: 45000 },
                    { id: 32, serial: '0332 00418 00049', name: 'ULV Leco 1800 E', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2009-05-25', status: 'available', notes: '', price: 250000 },
                    { id: 33, serial: '0332 0418 0098 (TL 060545)', name: 'TWISTER XL BY DYNAFOG', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡∏ù‡∏≠‡∏¢', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2015-08-05', status: 'pending_repair_approval', notes: '‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î', price: 22000 },
                    { id: 34, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0105 (154710)', name: 'Swingtec ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2016-05-10', status: 'available', notes: '', price: 75000 },
                    { id: 35, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0104 (154714)', name: 'Swingtec ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2016-05-29', status: 'available', notes: '', price: 75000 },
                    { id: 36, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0121', name: 'FONTAN PORTASTARS', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2016-11-29', status: 'available', notes: '', price: 35000 },
                    { id: 37, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0122', name: 'FONTAN PORTASTARS', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2016-11-29', status: 'available', notes: '', price: 35000 },
                    { id: 38, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0126', name: 'FONTAN PORTASTARS', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2016-11-29', status: 'available', notes: '', price: 35000 },
                    { id: 39, serial: '0334 0461 1260', name: 'Misuko 3WF-3A', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2018-01-12', status: 'available', notes: '', price: 4000 },
                    { id: 40, serial: '0332 0461 11600124', name: 'Swingtac ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2018-01-12', status: 'available', notes: '', price: 75000 },
                ],
                borrows: [
                    { id: 1, equipment_ids: [19], user_id: 4, user_name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', borrow_date: '2025-09-10', due_date: '2025-09-17', return_date: null, purpose: '‡∏û‡πà‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£', contact_name: '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏®‡∏£‡∏µ', contact_phone: '081-234-5678', notes: '‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢', status: 'borrowed' }
                ],
                repairs: [
                    { id: 1, equipment_id: 30, equipment_name: 'IGEBA PORT 123 ULV', damage_description: '‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡πà‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', status: 'repair_approved', technician_id: 3, repair_details: null, cost: null, parts_used: null, request_date: '2025-08-15' },
                    { id: 2, equipment_id: 33, equipment_name: 'TWISTER XL BY DYNAFOG', damage_description: '‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î', status: 'pending_repair_approval', technician_id: null, repair_details: null, cost: null, parts_used: null, request_date: '2025-08-18' },
                ],
                users: [
                    { id: 1, full_name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', email: 'admin@example.com', role: 'admin', status: 'active', agency: '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', address: '-', phone: '0' },
                    { id: 2, full_name: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', email: 'approver@example.com', role: 'approver', status: 'active', agency: '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà', address: '-', phone: '0' },
                    { id: 3, full_name: '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', email: 'tech@example.com', role: 'technician', status: 'active', agency: '‡πÅ‡∏ú‡∏ô‡∏Å‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', address: '-', phone: '0' },
                    { id: 4, full_name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', email: 'user@example.com', role: 'user', status: 'active', agency: '‡∏≠‡∏ö‡∏ï. ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', address: '123 ‡∏ñ.‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó', phone: '080-000-0000' },
                ],
                pendingUsers: [
                    { id: 5, full_name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', email: 'somchai@example.com', role: 'user', status: 'pending_approval', agency: '‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ô‡∏Ñ‡∏£', address: '456 ‡∏ñ.‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°', phone: '090-000-0000' }
                ],
                assessments: [],
                notifications: [],
                seq: { borrow: 2, repair: 3, user: 6, equip: 41, assessment: 1, notification: 1 }
            };
            let audioCtx;

            const api = {
                login: async (email, password) => {
                    const u = state.users.find(x => x.email === email);
                    if (!u || password !== 'password') throw new Error('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    if (u.status !== 'active') throw new Error('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                    return { id: u.id, name: u.full_name, role: u.role };
                },
                register: async (data) => {
                    if (state.users.some(u => u.email === data.email) || state.pendingUsers.some(u => u.email === data.email)) throw new Error('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                    state.pendingUsers.push({ id: state.seq.user++, ...data, role: 'user', status: 'pending_approval' });
                    addNotification('‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', ['admin', 'approver']);
                    return { message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
                },
                listAllUsers: async () => [...state.users, ...state.pendingUsers].sort((a, b) => a.id - b.id),
                listPendingUsers: async () => state.pendingUsers,
                approveUser: async (id) => {
                    const idx = state.pendingUsers.findIndex(u => u.id === id);
                    if (idx < 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');
                    const [u] = state.pendingUsers.splice(idx, 1);
                    state.users.push({ ...u, status: 'active' });
                    addNotification(`‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${u.full_name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`, [u.id]);
                    return true;
                },
                rejectUser: async (id) => {
                    state.pendingUsers = state.pendingUsers.filter(u => u.id !== id);
                    return true;
                },
                equipmentList: async (q = '', f = '', t = '') => {
                    let list = [...state.equipment];
                    if (q) list = list.filter(e => e.name.toLowerCase().includes(q.toLowerCase()) || e.serial.toLowerCase().includes(q.toLowerCase()));
                    if (f) {
                        if (f === 'all') {
                             list = list.filter(e => e.status === 'available' || e.status === 'borrowed');
                        } else {
                            list = list.filter(e => e.status === f);
                        }
                    }
                    if (t) list = list.filter(e => e.type === t);
                    return list;
                },
                addEquipment: async (data) => {
                    if (state.equipment.some(e => e.serial === data.serial)) throw new Error('Serial number ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                    state.equipment.push({ id: state.seq.equip++, ...data, status: data.status || 'available' });
                    addNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà: ${data.name}`, ['admin', 'technician']);
                    return true;
                },
                updateEquipment: async (id, data) => {
                    const equip = state.equipment.find(e => e.id === id);
                    if (!equip) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå');
                    Object.assign(equip, data);
                    return true;
                },
                deleteEquipment: async (id) => {
                    state.equipment = state.equipment.filter(e => e.id !== id);
                    return true;
                },
                createBorrow: async (payload) => {
                    const { equipment_types, ...details } = payload;
                    if (!equipment_types || equipment_types.length === 0) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó');
                    
                    const assigned_ids = [];
                    equipment_types.forEach(type => {
                        const availableEquip = state.equipment.find(e => e.type === type && e.status === 'available');
                        if (!availableEquip) throw new Error(`‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "${type}" ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ`);
                        assigned_ids.push(availableEquip.id);
                        availableEquip.status = 'reserved'; // Temporarily reserve
                    });

                    const due = new Date(details.borrow_date);
                    due.setDate(due.getDate() + 7);
                    const due_date = due.toISOString().slice(0, 10);
                    state.borrows.push({
                        id: state.seq.borrow++, equipment_ids: assigned_ids, ...details, user_name: state.user.name, due_date, return_date: null, status: 'pending_borrow_approval'
                    });
                     state.equipment.forEach(e => { if(e.status === 'reserved') e.status = 'available'; }); // Clear reservation
                    addNotification(`‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å ${state.user.name}`, ['admin', 'approver']);
                    return true;
                },
                myBorrows: async (user_id) => state.borrows.filter(b => b.user_id === user_id).sort((a, b) => b.id - a.id),
                listBorrowRequests: async () => state.borrows.filter(b => b.status === 'pending_borrow_approval'),
                approveBorrow: async (id) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    b.status = 'pending_delivery';
                    addNotification(`‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`, ['admin', 'technician', b.user_id]);
                    return true;
                },
                adminCancelBorrow: async (id) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    b.status = 'cancelled';
                    b.equipment_ids.forEach(eid => {
                        const eq = state.equipment.find(e => e.id === eid);
                        if (eq) eq.status = 'available';
                    });
                    addNotification(`‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢ Admin`, [b.user_id]);
                    return true;
                },
                performPreDeliveryCheck: async (id, replacements, checklistData) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    b.pre_delivery_checklist = checklistData;
                    
                    replacements.forEach(rep => {
                        const oldEquip = state.equipment.find(e => e.id === rep.faultyId);
                        if(oldEquip) oldEquip.status = 'pending_repair_approval';
                        state.repairs.push({ id: state.seq.repair++, equipment_id: oldEquip.id, equipment_name: oldEquip.name, damage_description: '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö', status: 'pending_repair_approval', technician_id: null, request_date: new Date().toISOString().slice(0, 10) });
                        addNotification(`‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà ${oldEquip.name} ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö`, ['admin', 'approver']);
                        
                        const idx = b.equipment_ids.indexOf(rep.faultyId);
                        if(idx > -1) b.equipment_ids[idx] = rep.newId;
                    });
                    
                    b.status = 'borrowed';
                    b.equipment_ids.forEach(equip_id => {
                        const eq = state.equipment.find(e => e.id === equip_id);
                        if (eq) eq.status = 'borrowed';
                    });
                    addNotification(`‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß`, [b.user_id]);
                    return true;
                },
                rejectBorrow: async (id) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    b.status = 'rejected';
                    addNotification(`‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò`, [b.user_id]);
                    return true;
                },
                queueForDelivery: async () => state.borrows.filter(b => b.status === 'pending_delivery'),
                queueForReturn: async () => state.borrows.filter(b => b.status === 'borrowed' && !b.return_date),
                techInspectReturn: async (id, isDamaged, notes, checklistData, lateReason) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    const today = new Date();
                    const dueDate = new Date(b.due_date);
                    b.actual_return_date = today.toISOString().slice(0, 10);
                    b.post_return_checklist = checklistData;
                    if (today > dueDate) {
                        b.late_return_reason = lateReason;
                        b.status = 'returned_late';
                    } else {
                        b.status = 'returned_early';
                    }
                    b.equipment_ids.forEach((equip_id) => {
                        const eq = state.equipment.find(e => e.id === equip_id);
                        if (!eq) return;
                        if (isDamaged) {
                            eq.status = 'pending_repair_approval';
                            state.repairs.push({ id: state.seq.repair++, equipment_id: eq.id, equipment_name: eq.name, damage_description: notes || `‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ä‡∏∏‡∏î‡∏¢‡∏∑‡∏° #${b.id})`, status: 'pending_repair_approval', request_date: new Date().toISOString().slice(0,10) });
                            addNotification(`‡∏û‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∏‡∏î: ${eq.name}`, ['admin', 'approver']);
                        } else {
                            eq.status = 'available';
                        }
                    });
                    if (isDamaged) b.status = 'returned_damaged';
                    addNotification(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${b.user_name} ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß`, ['admin', b.user_id]);
                    return true;
                },
                listRepairs: async () => state.repairs.sort((a, b) => b.id - a.id),
                listRepairRequests: async () => state.repairs.filter(r => r.status === 'pending_repair_approval'),
                approveRepair: async (id) => {
                    const r = state.repairs.find(x => x.id === id);
                    if (!r) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    r.status = 'repair_approved';
                    r.technician_id = state.user.role === 'technician' ? state.user.id : null;
                    const eq = state.equipment.find(e => e.id === r.equipment_id);
                    if (eq) eq.status = 'under_maintenance';
                    addNotification(`‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏° ${r.equipment_name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`, ['admin', 'technician']);
                    return true;
                },
                rejectRepair: async (id) => {
                    const r = state.repairs.find(x => x.id === id);
                    if (!r) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    r.status = 'repair_rejected';
                    const eq = state.equipment.find(e => e.id === r.equipment_id);
                    if (eq) eq.status = 'available';
                    return true;
                },
                completeRepair: async (id, details) => {
                    const r = state.repairs.find(x => x.id === id);
                    if (!r) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    r.status = 'completed';
                    Object.assign(r, details);
                    const eq = state.equipment.find(e => e.id === r.equipment_id);
                    if (eq) eq.status = 'available';
                    addNotification(`${r.equipment_name} ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`, ['admin', 'approver']);
                    return true;
                },
                createAssessment: async (data) => {
                    state.assessments.push({ id: state.seq.assessment++, ...data, date: new Date().toISOString().slice(0, 10) });
                    return true;
                },
                getReportData: async (filterMonth) => {
                    const filteredBorrows = filterMonth ? state.borrows.filter(b => b.borrow_date.startsWith(filterMonth)) : state.borrows;
                    const filteredRepairs = filterMonth ? state.repairs.filter(r => (r.request_date || '').startsWith(filterMonth)) : state.repairs;
                    const completedRepairs = filteredRepairs.filter(r => r.status === 'completed' && r.cost);
                    const totalCost = completedRepairs.reduce((sum, r) => sum + Number(r.cost), 0);
                    return {
                        totalBorrows: filteredBorrows.length,
                        totalRepairs: filteredRepairs.length,
                        totalRepairCost: totalCost
                    };
                }
            };

            const toast = (msg, isError = false) => {
                const el = $('#toast');
                el.textContent = msg;
                el.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-5 py-3 rounded-lg text-white text-sm font-medium shadow-lg transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-slate-800'}`;
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 2500);
            };
            
            const setTabs = (tabId) => {
                $$('.tab-btn').forEach(b => {
                    const isSelected = b.dataset.tab === tabId;
                    b.classList.toggle('bg-white', isSelected);
                    b.classList.toggle('text-slate-900', isSelected);
                    b.classList.toggle('font-semibold', isSelected);
                    if (b.closest('#sidebarNav')) {
                        b.classList.toggle('bg-white/10', !isSelected);
                    } else {
                        b.classList.toggle('hover:bg-white/20', !isSelected);
                    }
                });
                $$('.tab-content').forEach(c => c.classList.toggle('hidden', c.id !== tabId));
            };
            const showModal = (title, content, actions) => {
                $('#modalTitle').textContent = title;
                $('#modalBody').innerHTML = content + (actions ? `<div class="mt-6 flex justify-end gap-3">${actions}</div>` : '');
                $('#modal').classList.remove('hidden');
                setTimeout(() => {
                    $('#modal').style.opacity = '1';
                    $('#modalContent').classList.remove('scale-95');
                }, 10);
            };
            
            const statusMap = {
                available: { text: '‡∏ß‡πà‡∏≤‡∏á', color: 'bg-emerald-100 text-emerald-800' },
                borrowed: { text: '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°', color: 'bg-indigo-100 text-indigo-800' },
                under_maintenance: { text: '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', color: 'bg-amber-100 text-amber-800' },
                pending_repair_approval: { text: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°', color: 'bg-rose-100 text-rose-800' }
            };
            const roleMap = { admin: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', approver: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', technician: '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', user: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' };
            function playNotificationSound() {
                if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.5);
            }
            function addNotification(message, target) {
                state.notifications.unshift({ id: state.seq.notification++, message, target, timestamp: new Date(), read: false });
                playNotificationSound();
                renderNotifications();
            }
            function toggleNotificationDropdown() {
                const dropdown = $('#notificationDropdown');
                dropdown.classList.toggle('hidden');
                if (!dropdown.classList.contains('hidden')) {
                    state.notifications.forEach(n => {
                        if (Array.isArray(n.target) && (n.target.includes(state.user.role) || n.target.includes(state.user.id))) {
                            n.read = true;
                        }
                    });
                    renderNotifications();
                    setTimeout(() => { dropdown.classList.add('hidden'); }, 3000);
                }
            }

            async function renderEquipmentLists(options = {}) {
                const { forAssessment = false } = options;
                if (state.user && $('#dashEquipList')) {
                    const q2 = $('#dashEquipSearch')?.value || '';
                    const f2 = $('#dashEquipFilter')?.value || '';
                    const list2 = await api.equipmentList(q2, f2);
                    $('#dashEquipList').innerHTML = list2.map(e => {
                        const { text, color } = statusMap[e.status] || { text: 'N/A', color: 'bg-gray-100' };
                        const adminButtons = state.user.role === 'admin' ? `<div class="mt-2 flex gap-2"><button onclick="handleEditEquipmentClick(${e.id})" class="text-xs text-blue-600 hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button onclick="handleDeleteEquipmentClick(${e.id})" class="text-xs text-red-600 hover:underline">‡∏•‡∏ö</button></div>` : '';
                        return `<div class="rounded-xl border border-slate-200 p-4 bg-white"><div class="font-semibold">${e.name}</div><div class="text-sm text-slate-500">S/N: ${e.serial}</div><div class="text-xs text-slate-400 mt-1">${e.type}</div><span class="mt-2 inline-block text-xs font-medium px-2 py-1 rounded-full ${color}">${text}</span>${adminButtons}</div>`;
                    }).join('') || `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>`;
                    
                    if (forAssessment && $('#assessmentEquipList')) {
                        const t3 = $('#assessmentTypeFilter')?.value || '';
                        const list3 = await api.equipmentList('', '', t3);
                        $('#assessmentEquipList').innerHTML = list3.map(e => `<button onclick="handleAssessmentClick(${e.id}, '${e.name}')" class="text-left p-4 rounded-xl border border-slate-200 hover:bg-slate-50"><div class="font-semibold">${e.name}</div><div class="text-sm text-slate-500">S/N: ${e.serial}</div><div class="text-xs text-slate-400 mt-1">${e.type}</div></button>`).join('') || `<p class="text-slate-500 col-span-full">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ</p>`;
                    }
                }
            }
            async function renderSummaries() {
                if (!$('#equipmentSummary')) return;
                const equipSummary = await api.equipmentList();
                const total = equipSummary.length;
                const borrowed = equipSummary.filter(e => e.status === 'borrowed').length;
                const maintenance = equipSummary.filter(e => ['under_maintenance', 'pending_repair_approval'].includes(e.status)).length;
                const available = equipSummary.filter(e => e.status === 'available').length;
                $('#equipmentSummary').innerHTML = `<div class="rounded-xl p-4 bg-blue-100 text-blue-800"><div class="text-sm">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="text-2xl font-bold mt-1">${total}</div></div><div class="rounded-xl p-4 bg-emerald-100 text-emerald-800"><div class="text-sm">‡∏ß‡πà‡∏≤‡∏á</div><div class="text-2xl font-bold mt-1">${available}</div></div><div class="rounded-xl p-4 bg-indigo-100 text-indigo-800"><div class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><div class="text-2xl font-bold mt-1">${borrowed}</div></div><div class="rounded-xl p-4 bg-amber-100 text-amber-800"><div class="text-sm">‡∏£‡∏≠/‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</div><div class="text-2xl font-bold mt-1">${maintenance}</div></div>`;
                const userSummaryContainer = $('#userSummaryContainer');
                if (!state.user || !['admin', 'approver'].includes(state.user.role)) {
                    if (userSummaryContainer) userSummaryContainer.classList.add('hidden');
                } else {
                    if (userSummaryContainer) userSummaryContainer.classList.remove('hidden');
                    const allUsers = await api.listAllUsers();
                    const activeCount = allUsers.filter(u => u.status === 'active').length;
                    const pendingCount = allUsers.filter(u => u.status === 'pending_approval').length;
                    $('#userSummary').innerHTML = `<div class="rounded-xl p-4 bg-green-100 text-green-800"><div class="text-sm">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</div><div class="text-2xl font-bold mt-1">${activeCount}</div></div><div class="rounded-xl p-4 bg-yellow-100 text-yellow-800"><div class="text-sm">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="text-2xl font-bold mt-1">${pendingCount}</div></div>`;
                }
            }
             async function renderBorrowHistory() {
                if (!state.user || !$('#myBorrowsHistory')) return;
                 const allMyBorrows = await api.myBorrows(state.user.id);
                 const filter = $('#borrowHistoryFilter .bg-white')?.dataset?.filter || 'all';
                 let historyBorrows = [];
                 if (filter === 'all') { historyBorrows = allMyBorrows; }
                 else if (filter === 'borrowed') { historyBorrows = allMyBorrows.filter(b => ['pending_borrow_approval', 'pending_delivery', 'borrowed'].includes(b.status)); }
                 else if (filter === 'returned') { historyBorrows = allMyBorrows.filter(b => !['pending_borrow_approval', 'pending_delivery', 'borrowed'].includes(b.status)); }
                $('#myBorrowsHistory').innerHTML = historyBorrows.length === 0 ? `<p class="text-slate-500 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>` : historyBorrows.map(b => renderBorrowCard(b)).join('');
            }
            function renderBorrowCard(b) {
                const equipments = b.equipment_ids.map(id => state.equipment.find(e => e.id === id));
                let statusText, statusColor;
                switch (b.status) {
                    case 'pending_borrow_approval': statusText = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'; statusColor = 'bg-yellow-100 text-yellow-800'; break;
                    case 'pending_delivery': statusText = '‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à'; statusColor = 'bg-cyan-100 text-cyan-800'; break;
                    case 'borrowed': statusText = '‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà'; statusColor = 'bg-blue-100 text-blue-800'; break;
                    case 'rejected': statusText = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'; statusColor = 'bg-red-100 text-red-800'; break;
                    case 'cancelled': statusText = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'; statusColor = 'bg-gray-100 text-gray-800'; break;
                    case 'returned_early': statusText = '‡∏Ñ‡∏∑‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î'; statusColor = 'bg-teal-100 text-teal-800'; break;
                    case 'returned_late': statusText = '‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤'; statusColor = 'bg-orange-100 text-orange-800'; break;
                    case 'returned': statusText = '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß'; statusColor = 'bg-green-100 text-green-800'; break;
                    case 'returned_damaged': statusText = '‡∏Ñ‡∏∑‡∏ô (‡∏ä‡∏≥‡∏£‡∏∏‡∏î)'; statusColor = 'bg-orange-100 text-orange-800'; break;
                    default: statusText = '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'; statusColor = 'bg-gray-100 text-gray-800';
                }
                return `<div class="p-3 rounded-lg border border-slate-200 text-sm"><div class="flex justify-between items-start"><span class="font-semibold">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${b.id} (${b.equipment_ids.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</span><span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">${statusText}</span></div><ul class="list-disc list-inside text-slate-500 mt-1">${equipments.map(eq => `<li>${eq?.name || 'N/A'}</li>`).join('')}</ul><p class="text-slate-600 mt-1">‡∏¢‡∏∑‡∏°: ${b.borrow_date} | ‡∏Ñ‡∏∑‡∏ô: ${b.due_date}</p>${b.late_return_reason ? `<p class="text-xs text-red-600 mt-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏ä‡πâ‡∏≤: ${b.late_return_reason}</p>` : ''}</div>`;
            }
            async function renderApprovalLists() {
                if (!state.user || !['admin', 'approver'].includes(state.user.role) || !$('#approvalUsers')) return;
                const pendingUsers = await api.listPendingUsers();
                $('#approvalUsers').innerHTML = pendingUsers.length === 0 ? `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>` : pendingUsers.map(u => `<div class="p-3 rounded-lg border border-slate-200"><p class="font-semibold">${u.full_name} (${u.agency})</p><div class="text-sm text-slate-600 bg-slate-50 p-2 rounded-md mt-1"><p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${u.email}</p><p><strong>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> ${u.phone}</p><p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${u.address}</p></div><div class="mt-2 flex gap-2"><button onclick="handleApproveUser(${u.id})" class="px-3 py-1 text-sm rounded bg-emerald-500 text-white hover:bg-emerald-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button onclick="handleRejectUser(${u.id})" class="px-3 py-1 text-sm rounded bg-rose-500 text-white hover:bg-rose-600">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></div></div>`).join('');
                
                const borrowReqs = await api.listBorrowRequests();
                $('#approvalBorrowList').innerHTML = borrowReqs.length === 0 ? `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>` : borrowReqs.map(b => { 
                    const equipments = b.equipment_ids.map(id => state.equipment.find(e => e.id === id)); 
                    return `<div class="p-3 rounded-lg border border-slate-200"><p><span class="font-semibold">${b.user_name}</span> ‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° <span class="font-semibold">${b.equipment_ids.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span></p><div class="text-sm text-slate-600 bg-slate-50 p-2 rounded-md mt-1"><p class="font-medium text-slate-800">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ:</p><ul class="list-disc list-inside">${equipments.map(e => `<li>${e?.name} (${e?.type}) - S/N: ${e?.serial}</li>`).join('')}</ul><hr class="my-2"><p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${b.borrow_date} ‡∏ñ‡∏∂‡∏á ${b.due_date}</p><p><strong>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</strong> ${b.purpose}</p><p><strong>‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô:</strong> ${b.contact_name} (${b.contact_phone})</p><p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${b.notes || '-'}</p></div><div class="mt-2 flex gap-2"><button onclick="handleApproveBorrow(${b.id})" class="px-3 py-1 text-sm rounded bg-emerald-500 text-white hover:bg-emerald-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button onclick="handleRejectBorrow(${b.id})" class="px-3 py-1 text-sm rounded bg-rose-500 text-white hover:bg-rose-600">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></div></div>` 
                }).join('');

                const repairReqs = await api.listRepairRequests();
                $('#approvalRepairList').innerHTML = repairReqs.length === 0 ? `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>` : repairReqs.map(r => `<div class="p-3 rounded-lg border border-slate-200"><p>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏° <span class="font-semibold">${r.equipment_name}</span></p><div class="text-sm text-slate-600 bg-slate-50 p-2 rounded-md mt-1"><p><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</strong> ${r.damage_description}</p>${r.repair_details ? `<p><strong>‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°:</strong> ${r.repair_details}</p>` : ''}</div><div class="mt-2 flex gap-2"><button onclick="handleApproveRepair(${r.id})" class="px-3 py-1 text-sm rounded bg-emerald-500 text-white hover:bg-emerald-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button onclick="handleRejectRepair(${r.id})" class="px-3 py-1 text-sm rounded bg-rose-500 text-white hover:bg-rose-600">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></div></div>`).join('');
            }
            async function renderTechnicianQueues() {
                if (!state.user || !['admin', 'technician'].includes(state.user.role) || !$('#techDeliveryQueue')) return;
                const deliveryQueue = await api.queueForDelivery();
                $('#techDeliveryQueue').innerHTML = deliveryQueue.length === 0 ? `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</p>` : deliveryQueue.map(b => {
                    const equipDetails = b.equipment_ids.map(id => state.equipment.find(e => e.id === id)).map(e => `<li>${e.name} (${e.type})</li>`).join('');
                    return `<div class="p-3 rounded-lg border border-slate-200 text-sm"><div class="flex justify-between"><p>‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÉ‡∏´‡πâ <span class="font-semibold">${b.user_name}</span></p>${state.user.role === 'admin' ? `<button onclick="handleAdminCancelBorrow(${b.id})" class="text-xs text-red-500 hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>` : ''}</div><ul class="text-slate-600 list-disc list-inside">${equipDetails}</ul><button onclick="handlePreDeliveryCheck(${b.id})" class="mt-2 w-full px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 text-xs">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</button></div>`
                }).join('');
                
                const returnQueue = await api.queueForReturn();
                $('#techReturnQueue').innerHTML = returnQueue.length === 0 ? `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û</p>` : returnQueue.map(b => { 
                    const isLate = new Date() > new Date(b.due_date); 
                    const equipDetails = b.equipment_ids.map(id => state.equipment.find(e => e.id === id)).map(e => `<li>${e.name} (${e.type})</li>`).join('');
                    return `<div class="p-3 rounded-lg border ${isLate ? 'border-red-300 bg-red-50' : 'border-slate-200'} text-sm"><p><span class="font-semibold">${b.user_name}</span> ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p><ul class="text-slate-600 list-disc list-inside">${equipDetails}</ul><p class="text-slate-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${b.due_date}</p>${isLate ? `<p class="text-xs font-semibold text-red-600">‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤!</p>` : ''}<button onclick="handleReturnClick(${b.id})" class="mt-2 w-full px-3 py-1 rounded bg-orange-500 text-white hover:bg-orange-600 text-xs">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</button></div>` 
                }).join('');

                const repairs = await api.listRepairs();
                $('#repairList').innerHTML = repairs.filter(r => r.status !== 'completed').length === 0 ? `<div class="text-slate-500 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>` : repairs.filter(r => r.status !== 'completed').map(r => renderRepairCard(r)).join('');
            }
             async function renderRepairHistory() {
                if (!state.user || !['admin', 'technician'].includes(state.user.role) || !$('#allRepairsHistory')) return;
                const repairs = await api.listRepairs();
                $('#allRepairsHistory').innerHTML = repairs.length === 0 ? `<div class="text-slate-500 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</div>` : repairs.map(r => renderRepairCard(r, true)).join('');
            }
            function renderRepairCard(r, isHistory = false) {
                 let statusText, statusColor;
                const equip = state.equipment.find(e => e.id === r.equipment_id);
                switch (r.status) {
                    case 'pending_repair_approval': statusText = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°'; statusColor = 'bg-yellow-100 text-yellow-800'; break;
                    case 'repair_approved': statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°'; statusColor = 'bg-blue-100 text-blue-800'; break;
                    case 'repair_rejected': statusText = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°'; statusColor = 'bg-red-100 text-red-800'; break;
                    case 'completed': statusText = '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à'; statusColor = 'bg-green-100 text-green-800'; break;
                }
                const canComplete = r.status === 'repair_approved' && (state.user.role === 'technician' || state.user.role === 'admin');
                const adminDelete = isHistory && state.user.role === 'admin' ? `<button class="text-xs text-red-500 hover:underline" onclick="handleDeleteRepair(${r.id})">‡∏•‡∏ö</button>` : '';
                return `<div class="p-3 rounded-lg border border-slate-200 text-sm"><div class="flex justify-between items-start"><span class="font-semibold">${r.equipment_name} <span class="text-slate-500 font-normal">(${equip?.type || 'N/A'})</span></span><span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">${statusText}</span></div><p class="text-slate-600">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£: ${r.damage_description}</p>${canComplete ? `<button onclick="handleCompleteRepairClick(${r.id})" class="mt-2 px-3 py-1 text-xs rounded bg-indigo-500 text-white hover:bg-indigo-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</button>` : ''}${r.status === 'completed' ? `<div class="text-xs mt-1 text-slate-500 bg-slate-50 p-1.5 rounded"><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${r.repair_details || '-'} | <strong>‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°:</strong> ${r.cost || 0} ‡∏ö‡∏≤‡∏ó | <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°:</strong> ${r.repair_date}</div>` : ''}<div class="text-right mt-1">${adminDelete}</div></div>`;
            }
            let borrowChartInstance = null;
            let repairCostChartInstance = null;
            async function renderReports() {
                if (!state.user || !['admin', 'approver'].includes(state.user.role) || !$('#reportCards')) return;
                
                const filterMonth = $('#reportMonthFilter').value;
                
                const reportData = await api.getReportData(filterMonth);
                const equipSummary = await api.equipmentList();
                const totalEquip = equipSummary.length;

                $('#reportCards').innerHTML = `<div class="rounded-xl p-4 bg-blue-100 text-blue-800"><div class="text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="text-3xl font-bold mt-1">${totalEquip}</div></div><div class="rounded-xl p-4 bg-indigo-100 text-indigo-800"><div class="text-sm">‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div><div class="text-3xl font-bold mt-1">${reportData.totalBorrows}</div></div><div class="rounded-xl p-4 bg-amber-100 text-amber-800"><div class="text-sm">‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div><div class="text-3xl font-bold mt-1">${reportData.totalRepairs}</div></div><div class="rounded-xl p-4 bg-red-100 text-red-800"><div class="text-sm">‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div><div class="text-3xl font-bold mt-1">${reportData.totalRepairCost.toLocaleString()}.-</div></div>`;
                
                const borrowsToChart = filterMonth ? state.borrows.filter(b => b.borrow_date.startsWith(filterMonth)) : state.borrows;
                const repairsToChart = filterMonth ? state.repairs.filter(r => (r.request_date || '').startsWith(filterMonth)) : state.repairs;

                const dailyBorrows = borrowsToChart.reduce((acc, b) => { const day = b.borrow_date; acc[day] = (acc[day] || 0) + 1; return acc; }, {});
                const dailyRepairCosts = repairsToChart.reduce((acc, r) => { const day = r.request_date; acc[day] = (acc[day] || 0) + (Number(r.cost) || 0); return acc; }, {});

                if (borrowChartInstance) borrowChartInstance.destroy();
                borrowChartInstance = new Chart($('#borrowChart').getContext('2d'), {
                    type: 'bar',
                    data: { labels: Object.keys(dailyBorrows), datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', data: Object.values(dailyBorrows), backgroundColor: 'rgba(79, 70, 229, 0.7)' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });

                if (repairCostChartInstance) repairCostChartInstance.destroy();
                repairCostChartInstance = new Chart($('#repairCostChart').getContext('2d'), {
                    type: 'line',
                    data: { labels: Object.keys(dailyRepairCosts), datasets: [{ label: '‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏° (‡∏ö‡∏≤‡∏ó)', data: Object.values(dailyRepairCosts), backgroundColor: 'rgba(217, 70, 239, 0.2)', borderColor: 'rgba(217, 70, 239, 1)', fill: true, tension: 0.1 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' } }, scales: { y: { beginAtZero: true } } }
                });
            }
            function renderNotifications() {
                const notificationBtn = $('#notificationBtn');
                const notificationList = $('#notificationList');
                if (!state.user || !notificationList) return;
                const userNotifications = state.notifications.filter(n => (Array.isArray(n.target) && (n.target.includes(state.user.role) || n.target.includes(state.user.id))));
                if (userNotifications.length === 0) {
                    notificationList.innerHTML = `<p class="p-4 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</p>`;
                } else {
                    notificationList.innerHTML = userNotifications.map(n => `<div class="p-2 border-b border-slate-100 ${n.read ? 'opacity-60' : ''}"><p class="text-slate-700">${n.message}</p><p class="text-xs text-slate-400 mt-1">${new Date(n.timestamp).toLocaleString('th-TH')}</p></div>`).join('');
                }
                const hasUnread = userNotifications.some(n => !n.read);
                notificationBtn.classList.toggle('notification-dot', hasUnread);
            }

            window.handleApproveUser = async (id) => { try { await api.approveUser(id); toast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleRejectUser = async (id) => { try { await api.rejectUser(id); toast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleApproveBorrow = async (id) => { try { await api.approveBorrow(id); toast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à)'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleRejectBorrow = async (id) => { try { await api.rejectBorrow(id); toast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleAdminCancelBorrow = async (id) => { if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { try { await api.adminCancelBorrow(id); toast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); fullRender(); } catch (e) { toast(e.message, true); } } };
            window.handleApproveRepair = async (id) => { try { await api.approveRepair(id); toast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleRejectRepair = async (id) => { try { await api.rejectRepair(id); toast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleDeleteRepair = async (id) => { if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { state.repairs = state.repairs.filter(r => r.id !== id); toast('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); fullRender(); }};

            function getChecklistHTML(formId, checklist, equipment) {
                return equipment.map(equip => `
                    <div class="mt-4 border-t pt-3">
                         <p class="font-semibold text-sm mb-2">${equip.name} (S/N: ${equip.serial})</p>
                         ${checklist.map(item => `
                            <div class="grid grid-cols-3 items-center border-b py-2">
                                <label for="${formId}-${equip.id}-${item.id}" class="text-sm text-slate-700 col-span-2">${item.label}</label>
                                <div class="flex items-center justify-end gap-4">
                                     <label class="flex items-center gap-1"><input type="radio" data-equip-id="${equip.id}" name="${item.id}-${equip.id}" value="ok" class="h-4 w-4" checked> <span class="text-sm">‡∏õ‡∏Å‡∏ï‡∏¥</span></label>
                                     <label class="flex items-center gap-1"><input type="radio" data-equip-id="${equip.id}" name="${item.id}-${equip.id}" value="faulty" class="h-4 w-4"> <span class="text-sm">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span></label>
                                </div>
                            </div>`).join('')}
                    </div>
                `).join('');
            }
            window.handlePreDeliveryCheck = (borrowId) => {
                const borrow = state.borrows.find(b => b.id === borrowId);
                const equipmentInBorrow = borrow.equipment_ids.map(id => state.equipment.find(e => e.id === id));
                const inspectionChecklist = [
                    { id: 'check_exterior', label: '1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' }, { id: 'check_fuel_tank', label: '2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á' },
                    { id: 'check_carburetor', label: '3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏π‡πÄ‡∏£‡πÄ‡∏ï‡∏≠‡∏£‡πå' }, { id: 'check_spark_plug', label: '4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô' },
                    { id: 'check_battery', label: '5. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà' }, { id: 'check_chem_pipe', label: '6. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ' },
                    { id: 'check_nozzle_system', label: '7. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡πà‡∏ô' }
                ];
                const content = `
                <form id="preDeliveryForm" data-id="${borrowId}">
                    <p class="text-sm text-slate-600 mb-3">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${borrow.equipment_ids.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong>${borrow.user_name}</strong></p>
                    <div class="bg-slate-50 p-3 rounded-lg max-h-80 overflow-y-auto">${getChecklistHTML('preDeliveryForm', inspectionChecklist, equipmentInBorrow)}</div>
                     <textarea name="notes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" class="mt-3 w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                </form>`;
                const actions = `<button type="button" id="reportFaultBtn" class="px-4 py-2 rounded-lg bg-amber-500 text-white hover:bg-amber-600">‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
                                 <button type="submit" id="confirmDeliveryBtn" form="preDeliveryForm" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥)</button>`;
                showModal('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö', content, actions);
                
                const form = $('#preDeliveryForm');
                $('#reportFaultBtn').addEventListener('click', () => {
                     const faultyRadios = form.querySelectorAll('input[value="faulty"]:checked');
                     const faultyItems = [...new Set(Array.from(faultyRadios).map(r => parseInt(r.dataset.equipId)))].map(id => state.equipment.find(e => e.id === id));
                     if(faultyItems.length > 0) {
                        handleReportFault(borrowId, faultyItems);
                     } else {
                        toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà "‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥" ‡∏Å‡πà‡∏≠‡∏ô', true);
                     }
                });
            };

            window.handleReportFault = (borrowId, faultyItems) => {
                const content = `
                <form id="replaceEquipForm" data-id="${borrowId}">
                    <p class="text-sm text-slate-600 mb-3">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡πÅ‡∏ó‡∏ô</p>
                    <div class="space-y-4">
                    ${faultyItems.map(item => {
                        const availableReplacements = state.equipment.filter(e => e.status === 'available' && e.type === item.type);
                        return `
                        <div class="p-2 border rounded-md">
                             <p class="font-medium text-sm">‡πÄ‡∏™‡∏µ‡∏¢: ${item.name} <span class="text-slate-500">(${item.type})</span></p>
                             <select name="replacement_${item.id}" class="w-full mt-1 px-3 py-2 rounded-lg border border-slate-300" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏î‡πÅ‡∏ó‡∏ô --</option>
                                ${availableReplacements.map(e => `<option value="${e.id}">${e.name} (S/N: ${e.serial})</option>`).join('')}
                             </select>
                        </div>
                        `;
                    }).join('')}
                    </div>
                </form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                 <button type="submit" form="replaceEquipForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>`;
                showModal('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏î‡πÅ‡∏ó‡∏ô', content, actions);
            };

            window.handleReturnClick = (id) => {
                const borrow = state.borrows.find(b => b.id === id);
                const isLate = new Date() > new Date(borrow.due_date);
                const lateReasonHTML = isLate ? `<label class="block text-sm font-medium text-slate-700 mt-4">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤</label><textarea name="late_return_reason" rows="2" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." class="mt-1 w-full px-3 py-2 rounded-lg border border-red-300" required></textarea>` : '';
                const inspectionChecklist = [{ id: 'check_exterior', label: '1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' }, { id: 'check_fuel_tank', label: '2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á' }, { id: 'check_carburetor', label: '3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏π‡πÄ‡∏£‡πÄ‡∏ï‡∏≠‡∏£‡πå' }, { id: 'check_spark_plug', label: '4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô' }, { id: 'check_battery', label: '5. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà' }, { id: 'check_chem_pipe', label: '6. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ' }, { id: 'check_nozzle_system', label: '7. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡πà‡∏ô' }];
                const content = `<form id="postReturnForm" data-id="${id}"><div class="bg-slate-50 p-3 rounded-lg">${getChecklistHTML('postReturnForm', inspectionChecklist)}</div><label class="block text-sm font-medium text-slate-700 mt-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</label><select name="isDamaged" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm"><option value="false">‡∏õ‡∏Å‡∏ï‡∏¥</option><option value="true">‡∏ä‡∏≥‡∏£‡∏∏‡∏î (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</option></select><textarea name="notes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏´‡∏≤‡∏Å‡∏ä‡∏≥‡∏£‡∏∏‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£)" class="mt-2 w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>${lateReasonHTML}</form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="postReturnForm" class="px-4 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</button>`;
                showModal('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô', content, actions);
                const form = $('#postReturnForm');
                form.addEventListener('change', () => { form.querySelector('select[name="isDamaged"]').value = form.querySelectorAll('input[value="faulty"]:checked').length > 0 ? 'true' : 'false'; });
            };
            window.handleCompleteRepairClick = (id) => {
                const repair = state.repairs.find(r => r.id === id);
                const content = `<form id="completeRepairForm" data-id="${id}" class="space-y-3 text-sm"><div class="grid grid-cols-2 gap-3"><input name="repair_date" type="date" value="${new Date().toISOString().slice(0, 10)}" required class="w-full px-3 py-2 rounded-lg border border-slate-200"><input name="repair_by" required placeholder="‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°" value="${state.user.name}" class="w-full px-3 py-2 rounded-lg border border-slate-200"></div><div><label class="font-medium">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∏‡∏î:</label><p class="p-2 bg-slate-50 rounded-md">${repair.damage_description}</p></div><textarea name="repair_details" required rows="3" placeholder="‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°" class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea><textarea name="parts_used" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea><input name="cost" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" class="w-full px-3 py-2 rounded-lg border border-slate-200"></form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="completeRepairForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</button>`;
                showModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°', content, actions);
            };
            window.handleAssessmentClick = (id, name) => {
                const equip = state.equipment.find(e => e.id === id);
                const content = `<form id="assessmentForm" data-id="${id}" class="text-sm"><p class="text-base text-slate-600 mb-3">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: <strong>${name} (S/N: ${equip.serial})</strong></p><div class="grid md:grid-cols-2 gap-x-6 gap-y-3"><div><label class="font-medium">‡∏™‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</label><div class="flex gap-4 mt-1"><label><input type="radio" name="exterior_condition" value="new"> ‡πÉ‡∏´‡∏°‡πà</label><label><input type="radio" name="exterior_condition" value="mid" checked> ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</label><label><input type="radio" name="exterior_condition" value="old"> ‡πÄ‡∏Å‡πà‡∏≤</label></div></div><div><label class="font-medium">‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå</label><div class="flex gap-4 mt-1"><label><input type="radio" name="engine_start" value="easy" checked> ‡∏ï‡∏¥‡∏î‡∏á‡πà‡∏≤‡∏¢</label><label><input type="radio" name="engine_start" value="hard"> ‡∏ï‡∏¥‡∏î‡∏¢‡∏≤‡∏Å</label></div></div><div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-4 gap-3 bg-slate-50 p-2 rounded-md"><label class="font-medium col-span-full">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</label><label><input type="checkbox" name="clean_pipe"> ‡∏ó‡πà‡∏≠‡∏û‡πà‡∏ô</label> <label><input type="checkbox" name="clean_chem_line"> ‡∏™‡∏≤‡∏¢‡∏™‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏¢‡∏≤</label><label><input type="checkbox" name="clean_gas_tank"> ‡∏ñ‡∏±‡∏á‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô</label> <label><input type="checkbox" name="clean_chem_tank"> ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ñ‡∏°‡∏µ</label></div><div class="md:col-span-2"><h4 class="font-semibold mt-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h4><div class="grid sm:grid-cols-3 gap-3 mt-1"><input name="chem_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ" class="w-full px-3 py-2 rounded-lg border"><input name="chem_concentration" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô (%)" class="w-full px-3 py-2 rounded-lg border"><input name="chem_mix_ratio" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°" class="w-full px-3 py-2 rounded-lg border"></div></div><div class="md:col-span-2"><h4 class="font-semibold mt-2">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h4><div class="grid sm:grid-cols-2 gap-3 mt-1"><input name="result_temp" placeholder="‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡πà‡∏≠ (¬∞C)" class="w-full px-3 py-2 rounded-lg border"><input name="result_flow_rate" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏°‡∏•./‡∏ô‡∏≤‡∏ó‡∏µ)" class="w-full px-3 py-2 rounded-lg border"></div></div><textarea name="notes" placeholder="‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞" rows="2" class="w-full px-3 py-2 rounded-lg border md:col-span-2"></textarea></div></form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="assessmentForm" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>`;
                showModal('‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô', content, actions);
            };
            window.handleAddEquipmentClick = () => {
                const content = `<form id="addEquipForm" class="space-y-3"><input name="name" required placeholder="‡∏ä‡∏∑‡πà‡∏≠/‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠" class="w-full px-3 py-2 rounded-lg border border-slate-200"><input name="serial" required placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏£‡∏´‡∏±‡∏™" class="w-full px-3 py-2 rounded-lg border border-slate-200"><input name="type" required placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" class="w-full px-3 py-2 rounded-lg border border-slate-200"><input name="acquisition_date" type="date" required value="${new Date().toISOString().slice(0,10)}" class="w-full px-3 py-2 rounded-lg border border-slate-200"><input name="price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)" class="w-full px-3 py-2 rounded-lg border border-slate-200"><textarea name="notes" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" rows="2" class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea></form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="addEquipForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>`;
                showModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà', content, actions);
            };
            window.handleEditEquipmentClick = (id) => {
                const equip = state.equipment.find(e => e.id === id);
                const content = `<form id="editEquipForm" data-id="${id}" class="space-y-3"><input name="name" required value="${equip.name}" class="w-full px-3 py-2 rounded-lg border border-slate-200"><input name="serial" required value="${equip.serial}" class="w-full px-3 py-2 rounded-lg border border-slate-200"><input name="type" required value="${equip.type}" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" class="w-full px-3 py-2 rounded-lg border border-slate-200"><input name="acquisition_date" type="date" value="${equip.acquisition_date}" required class="w-full px-3 py-2 rounded-lg border border-slate-200"><input name="price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)" value="${equip.price || ''}" class="w-full px-3 py-2 rounded-lg border border-slate-200"><textarea name="notes" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" rows="2" class="w-full px-3 py-2 rounded-lg border border-slate-200">${equip.notes || ''}</textarea></form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="editEquipForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>`;
                showModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', content, actions);
            };
            window.handleViewUsersClick = async () => {
                const allUsers = await api.listAllUsers();
                const content = `<div class="max-h-96 overflow-y-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th scope="col" class="px-6 py-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th scope="col" class="px-6 py-3">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th><th scope="col" class="px-6 py-3">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th scope="col" class="px-6 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody>${allUsers.map(u => `<tr class="bg-white border-b"><th scope="row" class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${u.full_name}</th><td class="px-6 py-4">${u.agency}</td><td class="px-6 py-4">${u.email}</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${u.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${u.status === 'active' ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' : '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}</span></td></tr>`).join('')}</tbody></table></div>`;
                showModal('‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', content, '');
            };
            window.handleDeleteEquipmentClick = (id) => { if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { try { api.deleteEquipment(id); toast('‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); fullRender(); } catch (e) { toast(e.message, true); } } };
            window.handleReportProblem = () => {
                const content = `<form id="reportProblemForm"><p class="text-sm text-slate-600 mb-3">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤</p><textarea name="problem_description" rows="5" class="w-full px-3 py-2 rounded-lg border border-slate-200" required placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤..."></textarea></form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="reportProblemForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>`;
                showModal('‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö / ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞', content, actions);
            };
            async function handleDynamicFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const id = parseInt(form.dataset.id);
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    switch (form.id) {
                        case 'preDeliveryForm': 
                            await api.performPreDeliveryCheck(id, [], {}); 
                            toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); 
                            break;
                        case 'replaceEquipForm':
                             const replacements = Object.keys(data).filter(k => k.startsWith('replacement_')).map(k => {
                                 return { faultyId: parseInt(k.split('_')[1]), newId: parseInt(data[k]) };
                             });
                             await api.performPreDeliveryCheck(id, replacements, {});
                             toast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                             break;
                        case 'postReturnForm': 
                            await api.techInspectReturn(id, data.isDamaged === 'true', data.notes, {}, data.late_return_reason); 
                            toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); 
                            break;
                        case 'completeRepairForm': await api.completeRepair(id, data); toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); break;
                        case 'assessmentForm': await api.createAssessment({ equipment_id: id, ...data }); toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); break;
                        case 'addEquipForm': await api.addEquipment(data); toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); break;
                        case 'editEquipForm': await api.updateEquipment(id, data); toast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); break;
                        case 'reportProblemForm':
                            addNotification(`‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å ${state.user.name}: ${data.problem_description}`, ['admin', 'approver']);
                            toast('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞!'); 
                            break;
                    }
                    hideModal();
                    fullRender();
                } catch (err) { toast(err.message, true); }
            }
            async function handleLogin(e) { e.preventDefault(); const d = Object.fromEntries(new FormData(e.target).entries()); try { const user = await api.login(d.email, d.password); state.user = user; localStorage.setItem('yonchuw_user', JSON.stringify(user)); toast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${user.name}`); show('dashboard'); fullRender(); } catch (err) { toast(err.message, true); } e.target.reset(); }
            async function handleRegister(e) { e.preventDefault(); const d = Object.fromEntries(new FormData(e.target).entries()); if (!d.email.includes('@')) { toast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true); return; } if (d.password.length < 8) { toast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', true); return; } try { const res = await api.register(d); toast(res.message); show('loginPage'); } catch (err) { toast(err.message, true); } e.target.reset(); }
            function handleLogout() { state.user = null; localStorage.removeItem('yonchuw_user'); toast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); $('#demoModeBanner').classList.add('hidden'); show('home'); applyRoleVisibility(); }
            async function handleDemoLogin() { try { const user = await api.login('user@example.com', 'password'); state.user = user; localStorage.setItem('yonchuw_user', JSON.stringify(user)); toast(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ`); show('dashboard'); $('#demoModeBanner').classList.remove('hidden'); fullRender(); } catch (err) { toast(err.message, true); } }
            async function handleBorrowSubmit(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                if ($('#demoModeBanner').classList.contains('hidden') === false) { toast('‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); e.target.reset(); return; }
                const formData = new FormData(e.target);
                try {
                    btn.disabled = true;
                    const selectedEquipTypes = Array.from(e.target.querySelectorAll('input[name="equipment_types"]:checked')).map(cb => cb.value);
                    const details = Object.fromEntries(formData.entries());
                    delete details.equipment_types;
                    const payload = { equipment_types: selectedEquipTypes, ...details, user_id: state.user.id };
                    if (!payload.equipment_types.length || !payload.borrow_date || !payload.purpose || !payload.contact_name) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    await api.createBorrow(payload);
                    toast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    e.target.reset();
                    fullRender();
                } catch (err) {
                    toast(err.message, true);
                } finally { btn.disabled = false; }
            }
            function handleExitDemo() { state.user = null; localStorage.removeItem('yonchuw_user'); toast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); $('#demoModeBanner').classList.add('hidden'); show('home'); applyRoleVisibility(); }

            function applyRoleVisibility() {
                const loggedIn = !!state.user;
                $('#nav-actions').classList.toggle('hidden', window.innerWidth < 768 && loggedIn);
                $('#hamburgerBtn')?.classList.toggle('hidden', !loggedIn);
                $('#btnLogin').classList.toggle('hidden', loggedIn);
                $('#btnRegister').classList.toggle('hidden', loggedIn);
                $('#userInfo').classList.toggle('hidden', !loggedIn);
                $('#userInfo').classList.toggle('flex', loggedIn);
                const sidebarLogin = $('#sidebarLoginActions');
                const sidebarUserInfo = $('#sidebarUserInfo');
                if (sidebarLogin) sidebarLogin.classList.toggle('hidden', loggedIn);
                if (sidebarUserInfo) {
                    sidebarUserInfo.classList.toggle('hidden', !loggedIn);
                    sidebarUserInfo.classList.toggle('flex', loggedIn);
                }
                const allTabs = [
                    { id: 'equipmentTab', label: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', roles: ['admin', 'user', 'technician', 'approver'] },
                    { id: 'borrowTab', label: '‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', roles: ['admin', 'user'] },
                    { id: 'borrowHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', roles: ['admin', 'user'] },
                    { id: 'techTab', label: '‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á', roles: ['admin', 'technician'] },
                    { id: 'repairHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°', roles: ['admin', 'technician'] },
                    { id: 'approvalTab', label: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠', roles: ['admin', 'approver'] },
                    { id: 'assessmentTab', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô', roles: ['admin', 'technician'] },
                    { id: 'reportTab', label: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', roles: ['admin', 'approver'] }
                ];
                const desktopTabsContainer = $('#desktopTabs');
                const sidebarNavContainer = $('#sidebarNav');
                if (loggedIn) {
                    $('#userNameDisplay').textContent = state.user.name;
                    $('#sidebarUserNameDisplay').textContent = state.user.name;
                    const role = state.user.role;
                    $('#sidebarUserRoleDisplay').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${roleMap[role] || 'Unknown'}`;
                    const visibleTabs = allTabs.filter(tab => tab.roles.includes(role));
                    if (desktopTabsContainer) desktopTabsContainer.innerHTML = visibleTabs.map(tab => `<button data-tab="${tab.id}" class="tab-btn px-4 py-2 rounded-lg">${tab.label}</button>`).join('');
                    if (sidebarNavContainer) sidebarNavContainer.innerHTML = visibleTabs.map(tab => `<button data-tab="${tab.id}" class="tab-btn w-full text-left px-4 py-2 rounded-lg hover:bg-white/10">${tab.label}</button>`).join('');
                    $('#btnAddEquipDash').classList.toggle('hidden', role !== 'admin');
                    $('#notificationArea').classList.remove('hidden');
                } else {
                    if (desktopTabsContainer) desktopTabsContainer.innerHTML = '';
                    if (sidebarNavContainer) sidebarNavContainer.innerHTML = '';
                    $('#notificationArea').classList.add('hidden');
                }
            }
            function setupEventListeners() {
                const addListener = (selector, event, handler) => { const el = $(selector); if (el) { el.addEventListener(event, handler); } };
                const openSidebar = () => { const s = $('#sidebar'); if (s) { s.classList.remove('hidden'); setTimeout(() => { $('#sidebarBackdrop').style.opacity = '1'; $('#sidebarContent').classList.remove('-translate-x-full'); }, 10); } };
                const closeSidebar = () => { const sb = $('#sidebarBackdrop'), sc = $('#sidebarContent'); if (sb && sc) { sb.style.opacity = '0'; sc.classList.add('-translate-x-full'); setTimeout(() => { $('#sidebar').classList.add('hidden'); }, 300); } };
                addListener('#hamburgerBtn', 'click', openSidebar);
                addListener('#sidebarCloseBtn', 'click', closeSidebar);
                addListener('#sidebarBackdrop', 'click', closeSidebar);
                document.body.addEventListener('click', (e) => { const t = e.target; if (t.matches('.tab-btn')) { setTabs(t.dataset.tab); if (window.innerWidth < 768) closeSidebar(); } else if (t.id === 'sidebarBtnLogin') { closeSidebar(); show('loginPage'); } else if (t.id === 'sidebarBtnRegister') { closeSidebar(); show('registerPage'); } });
                addListener('#viewAllUsersBtn', 'click', handleViewUsersClick);
                addListener('#startBtn', 'click', () => state.user ? show('dashboard') : show('loginPage'));
                addListener('#borrowHistoryFilter', 'click', (e) => { if (e.target.tagName === 'BUTTON') { $$('#borrowHistoryFilter button').forEach(b => b.classList.remove('bg-white', 'shadow')); e.target.classList.add('bg-white', 'shadow'); renderBorrowHistory(); } });
                addListener('#btnAddEquipDash', 'click', handleAddEquipmentClick);
                addListener('#exitDemoBtn', 'click', handleExitDemo);
                addListener('#btnLogin', 'click', () => show('loginPage'));
                addListener('#btnRegister', 'click', () => show('registerPage'));
                addListener('#goRegister', 'click', (e) => { e.preventDefault(); show('registerPage'); });
                addListener('#browseBtn', 'click', handleDemoLogin);
                addListener('#backFromEquip', 'click', () => show('home'));
                addListener('#backFromLogin', 'click', () => show('home'));
                addListener('#backFromRegister', 'click', () => show('loginPage'));
                addListener('#btnLogout', 'click', handleLogout);
                addListener('#sidebarBtnLogout', 'click', handleLogout);
                addListener('#reportProblemBtn', 'click', handleReportProblem);
                addListener('#loginForm', 'submit', handleLogin);
                addListener('#registerForm', 'submit', handleRegister);
                addListener('#borrowForm', 'submit', handleBorrowSubmit);
                addListener('#modalClose', 'click', hideModal);
                addListener('#modal', 'click', (e) => { if (e.target.id === 'modal') hideModal() });
                document.addEventListener('submit', (e) => { if (['preDeliveryForm', 'postReturnForm', 'completeRepairForm', 'assessmentForm', 'addEquipForm', 'editEquipForm', 'replaceEquipForm', 'reportProblemForm'].includes(e.target.id)) { handleDynamicFormSubmit(e); } });
                addListener('#dashEquipSearch', 'input', () => renderEquipmentLists({ forAssessment: true }));
                addListener('#dashEquipFilter', 'change', () => renderEquipmentLists({ forAssessment: true }));
                addListener('#assessmentTypeFilter', 'change', () => renderEquipmentLists({ forAssessment: true }));
                addListener('#borrowDate', 'change', (e) => { if (e.target.value) { const d = new Date(e.target.value); d.setDate(d.getDate() + 7); $('#dueDate').value = d.toISOString().slice(0, 10); } else { $('#dueDate').value = ''; } });
                addListener('#notificationBtn', 'click', toggleNotificationDropdown);
                addListener('#reportMonthFilter', 'change', renderReports);
                addListener('#exportReportsBtn', 'click', handleExport);
            }
             function handleExport() {
                const filterMonth = $('#reportMonthFilter').value;
                const borrowsToExport = filterMonth ? state.borrows.filter(b => b.borrow_date.startsWith(filterMonth)) : state.borrows;
                const repairsToExport = filterMonth ? state.repairs.filter(r => (r.request_date || '').startsWith(filterMonth)) : state.repairs;
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,ID,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ/‡∏ä‡πà‡∏≤‡∏á,‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå,‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î,‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢\n";

                borrowsToExport.forEach(b => {
                    const equipNames = b.equipment_ids.map(id => state.equipment.find(e => e.id === id)?.name || id).join('; ');
                    csvContent += `‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°,${b.id},${b.borrow_date},${b.user_name},"${equipNames}","${b.purpose}",0\n`;
                });

                repairsToExport.forEach(r => {
                     csvContent += `‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°,${r.id},${r.request_date || ''},${state.users.find(u => u.id === r.technician_id)?.full_name || ''},"${r.equipment_name}","${r.damage_description}",${r.cost || 0}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `report_${filterMonth || 'all'}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                toast('Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
            function populateBorrowTypeList() {
                const listContainer = $('#borrowEquipTypeList');
                const availableTypes = [...new Set(state.equipment.filter(e => e.status === 'available').map(e => e.type))];
                if (listContainer) {
                    if (availableTypes.length === 0) { listContainer.innerHTML = `<p class="text-sm text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°</p>`; }
                    else { listContainer.innerHTML = availableTypes.map(type => `<label class="flex items-center p-2 rounded-md hover:bg-slate-50 text-sm"><input type="checkbox" name="equipment_types" value="${type}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span class="ml-2">${type}</span></label>`).join(''); }
                }
            }
            function populateAssessmentFilter() {
                const types = [...new Set(state.equipment.map(e => e.type))];
                const select = $('#assessmentTypeFilter');
                if (select) { select.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>' + types.map(t => `<option value="${t}">${t}</option>`).join(''); }
            }
            function fullRender() {
                applyRoleVisibility();
                if (state.user) {
                    const role = state.user.role;
                    let defaultTab = 'equipmentTab';
                    if (role === 'approver') defaultTab = 'approvalTab';
                    if (role === 'user') defaultTab = 'borrowTab';
                    if (role === 'technician') defaultTab = 'techTab';
                    const currentActiveTab = $('#desktopTabs .bg-white')?.dataset?.tab;
                    const allTabs = [
                        { id: 'equipmentTab', roles: ['admin', 'user', 'technician', 'approver'] },
                        { id: 'borrowTab', label: '‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', roles: ['admin', 'user'] },
                        { id: 'borrowHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', roles: ['admin', 'user'] },
                        { id: 'techTab', label: '‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á', roles: ['admin', 'technician'] },
                        { id: 'repairHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°', roles: ['admin', 'technician'] },
                        { id: 'approvalTab', label: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠', roles: ['admin', 'approver'] },
                        { id: 'assessmentTab', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô', roles: ['admin', 'technician'] },
                        { id: 'reportTab', label: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', roles: ['admin', 'approver'] }
                    ];
                    const currentTabInfo = allTabs.find(t => t.id === currentActiveTab);
                    if (!currentActiveTab || !currentTabInfo || !currentTabInfo.roles.includes(role)) {
                        setTabs(defaultTab);
                    } else {
                        setTabs(currentActiveTab);
                    }
                    renderSummaries();
                    renderBorrowHistory();
                    renderApprovalLists();
                    renderTechnicianQueues();
                    renderRepairHistory();
                    renderReports();
                    populateBorrowTypeList();
                    populateAssessmentFilter();
                    renderNotifications();
                }
                renderEquipmentLists({ forAssessment: true });
            }
            function init() {
                const savedUser = localStorage.getItem('yonchuw_user');
                if (savedUser) { state.user = JSON.parse(savedUser); show('dashboard'); }
                else { show('home'); }
                setupEventListeners();
                fullRender();
            }
            init();
        });
    </script>
</body>
</html>

